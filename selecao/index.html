<!DOCTYPE html>
<!-- saved from url=(0037)https://gov.portal.anvisa.org/selecao -->
<html lang="pt-br"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <title>ANVISA | Solicitação de Medicamento Regulamentado</title>

        <link rel="stylesheet" href="./index_files/rawline-fonts.css">
        <script src="./index_files/saved_resource"></script>
        <link href="./index_files/all.min.css" rel="stylesheet">

<!-- Scripts de tracking removidos para conformidade governamental -->
<!-- MS Clarity e UTMify pixel desabilitados por padrão -->
<!-- NOTA: Google Maps API carregado no final do <head> para evitar duplicação -->

        <style>
            .gov-header {
                background-color: #222222;
            }
            .inep-header {
                background-color: #044785;
            }
            .encceja-color {
                color: #3b5998;
            }
            .encceja-light {
                color: #a0a0a0;
            }
            .form-header {
                background-color: #2c5985;
                color: white;
            }
            .form-footer {
                background-color: #5d85ab;
                color: white;
            }

            button#submit-button {
                transition: all 0.2s ease;
                background-color: #5d85ab;
                color: rgba(255, 255, 255, 0.6);
            }

            button#submit-button:not([disabled]) {
                color: white;
                cursor: pointer;
            }

            button#submit-button:not([disabled]):hover {
                background-color: #4d7396;
            }
            .required-star {
                color: #ff0000;
            }
            .footer-bg {
                background-color: #1c2b39;
            }
            input::placeholder {
                font-family: 'Rawline', Arial, sans-serif;
            }
     
            .transparent {
                opacity: 0.5;
            }
            
<style>
  @font-face {
    font-family: 'Rawline';
    src: url("/static/fonts/rawline-400.woff2") format('woff2');
    font-weight: 400;
    font-style: normal;
  }
  @font-face {
    font-family: 'Rawline';
    src: url("/static/fonts/rawline-400i.woff2") format('woff2');
    font-weight: 400;
    font-style: italic;
  }
  @font-face {
    font-family: 'Rawline';
    src: url("/static/fonts/rawline-500.woff2") format('woff2');
    font-weight: 500;
    font-style: normal;
  }
  @font-face {
    font-family: 'Rawline';
    src: url("/static/fonts/rawline-600.woff2") format('woff2');
    font-weight: 600;
    font-style: normal;
  }
  @font-face {
    font-family: 'Rawline';
    src: url("/static/fonts/rawline-700.woff2") format('woff2');
    font-weight: 700;
    font-style: normal;
  }
  
  body {
    font-family: 'Rawline', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }
  
  .form-input {
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 8px 12px;
    width: 100%;
    font-size: 14px;
    background: #ffffff;
    transition: border-color 0.2s ease;
    font-family: 'Rawline', sans-serif;
  }
  
  .form-input:focus {
    border-color: #1451B4;
    outline: none;
  }
  
  .btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    font-family: 'Rawline', sans-serif;
  }
  
  .btn-primary {
    background: #1351b4;
    color: white;
  }
  
  .btn-primary:hover {
    background: #0c326f;
  }
  
  .btn i {
    margin-right: 8px;
    font-size: 12px;
  }

  .feature-card {
    background-color: #ffffff;
    border-radius: 8px;
    padding: 20px;
    border: 1px solid #e5e7eb;
    margin-bottom: 16px;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
  }
  
  .feature-title {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    font-family: 'Rawline', sans-serif;
  }
  
  .feature-title i {
    margin-right: 8px;
    color: #1451B4;
  }
  
  .feature-text {
    font-size: 14px;
    color: #6b7280;
    font-family: 'Rawline', sans-serif;
  }
  
  .secure-badge {
    display: inline-flex;
    align-items: center;
    background-color: #f0f7ff;
    color: #1451B4;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    font-family: 'Rawline', sans-serif;
      margin-right: 8px;
    }
    
    .secure-badge i {
      margin-right: 4px;
    }

    .delivery-address {
      background-color: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
      border: 1px solid #e5e7eb;
    }
    
    .address-title {
      font-size: 16px;
      font-weight: 600;
      color: #4b5563;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
    }
    
    .address-title i {
      margin-right: 8px;
      color: #1351b4;
    }
    
    .address-details {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    
    .address-change {
      font-size: 14px;
      color: #1351b4;
      text-decoration: underline;
      cursor: pointer;
    }

    /* Estilos para o alerta de estoque */
    .stock-alert {
      margin: 16px 0;
      background-color: #fffbeb;
      border: 1px solid #fef3c7;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .stock-indicator {
      display: flex;
      flex-direction: column;
      margin-bottom: 12px;
    }
    
    .stock-bar {
      height: 8px;
      background-color: #e5e7eb;
      border-radius: 4px;
      margin-bottom: 8px;
      overflow: hidden;
      position: relative;
    }
    
    .stock-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 18.4%;
      background: linear-gradient(90deg, #ef4444 0%, #f59e0b 100%);
      border-radius: 4px;
    }
    
    .stock-info {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
    }
    
    .stock-text {
      color: #1f2937;
      font-weight: 500;
    }
    
    .stock-count {
      color: #ef4444;
      font-weight: 700;
    }
    
    .stock-percent {
      color: #6b7280;
      font-size: 12px;
    }
    
    .stock-warning {
      display: flex;
      align-items: flex-start;
      background-color: #fef2f2;
      border-left: 4px solid #ef4444;
      padding: 12px;
      border-radius: 0 4px 4px 0;
    }
    
    .stock-warning i {
      color: #ef4444;
      font-size: 20px;
      margin-right: 12px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    
    .warning-title {
      font-weight: 600;
      color: #ef4444;
      margin-bottom: 4px;
      font-size: 16px;
    }
    
    .warning-text {
      color: #1f2937;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .benefits-list {
      display: grid;
      grid-template-columns: repeat(1, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    
    @media (min-width: 768px) {
      .benefits-list {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    .benefit-item {
      background-color: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
    }
    
    .benefit-item-title {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
    }
    
    .benefit-item-title i {
      margin-right: 8px;
      color: #16a34a;
    }
    
    .benefit-item-text {
      font-size: 14px;
      color: #6b7280;
      flex-grow: 1;
    }
    
    .product-review {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .stars {
      display: flex;
      margin-right: 8px;
    }
    
    .star {
      color: #facc15;
      margin-right: 2px;
    }
    
    .review-count {
      font-size: 14px;
      color: #6b7280;
    }
    
    .product-price-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    
    .product-original-price {
      font-size: 14px;
      color: #9ca3af;
      text-decoration: line-through;
    }
    
    .product-price {
      font-size: 24px;
      font-weight: 700;
      color: #1351b4;
    }
    
    .price-disclaimer {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
    
    .included-items {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #e5e7eb;
    }
    
    .included-title {
      font-size: 16px;
      font-weight: 600;
      color: #4b5563;
      margin-bottom: 12px;
    }
    
    .included-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .included-item i {
      color: #16a34a;
      margin-right: 8px;
    }
    
    .included-text {
      font-size: 14px;
      color: #6b7280;
    }

    /* Estilos do seletor de dosagem - Minimalista */
    .dosage-option {
      cursor: pointer;
      display: block;
    }

    .dosage-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      padding: 6px;
      text-align: center;
      transition: border-color 0.2s;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dosage-option input[type="radio"]:checked + .dosage-card {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    .dosage-card:hover {
      border-color: #3b82f6;
    }

    .dosage-value {
      font-weight: 500;
      font-size: 11px;
      color: #374151;
    }

    .dosage-option.recommended .dosage-card {
      border-color: #3b82f6;
      background: #f0f9ff;
    }

    .dosage-option.recommended .dosage-card::after {
      content: "●";
      position: absolute;
      top: -2px;
      right: -2px;
      color: #3b82f6;
      font-size: 6px;
    }

    .dosage-option.recommended input[type="radio"]:checked + .dosage-card {
      border-color: #3b82f6;
      background: #dbeafe;
    }

    /* Estilos do Loader Minimalista */
    .minimal-spinner {
      width: 28px;
      height: 28px;
      border: 2px solid #e5e7eb;
      border-top: 2px solid #1451B4;
      border-radius: 50%;
      animation: minimal-spin 1.2s linear infinite;
    }

    @keyframes minimal-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .minimal-progress-container {
      width: 280px;
      margin: 0 auto;
    }

    .minimal-progress-bar {
      width: 100%;
      height: 2px;
      background-color: #e5e7eb;
      border-radius: 1px;
      overflow: hidden;
    }

    .minimal-progress-fill {
      height: 100%;
      background-color: #1451B4;
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 1px;
    }

    /* Estilos para as etapas do loader */
    .loader-step {
      display: flex;
      align-items: center;
      padding: 8px 0;
      transition: all 0.3s ease;
    }

    .loader-step-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-size: 10px;
      transition: all 0.3s ease;
    }

    .loader-step-icon.pending {
      background-color: #e5e7eb;
      color: #9ca3af;
    }

    .loader-step-icon.active {
      background-color: #1351b4;
      color: white;
      animation: pulse-step 1.5s infinite;
    }

    .loader-step-icon.completed {
      background-color: #16a34a;
      color: white;
    }

    .loader-step-text {
      flex: 1;
      font-size: 13px;
    }

    .loader-step-title {
      font-weight: 500;
      color: #1f2937;
      margin-bottom: 2px;
    }

    .loader-step-details {
      font-size: 11px;
      color: #6b7280;
      line-height: 1.3;
    }

    .loader-step.active .loader-step-title {
      color: #1351b4;
      font-weight: 600;
    }

    .loader-step.completed .loader-step-title {
      color: #16a34a;
    }

    @keyframes pulse-step {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

</style>

    <style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.container{width:100%}@media (min-width: 640px){.container{max-width:640px}}@media (min-width: 768px){.container{max-width:768px}}@media (min-width: 1024px){.container{max-width:1024px}}@media (min-width: 1280px){.container{max-width:1280px}}@media (min-width: 1536px){.container{max-width:1536px}}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border-width:0}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{inset:0px}.left-0{left:0px}.right-0{right:0px}.top-0{top:0px}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.my-1{margin-top:0.25rem;margin-bottom:0.25rem}.my-4{margin-top:1rem;margin-bottom:1rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mr-2{margin-right:0.5rem}.mr-3{margin-right:0.75rem}.mt-2{margin-top:0.5rem}.mt-6{margin-top:1.5rem}.mb-1{margin-bottom:0.25rem}.mb-2{margin-bottom:0.5rem}.mb-3{margin-bottom:0.75rem}.mb-8{margin-bottom:2rem}.mr-1{margin-right:0.25rem}.mt-0\.5{margin-top:0.125rem}.mt-1{margin-top:0.25rem}.mt-3{margin-top:0.75rem}.mb-\[52px\]{margin-bottom:52px}.ml-4{margin-left:1rem}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-4{height:1rem}.h-6{height:1.5rem}.h-full{height:100%}.h-2{height:0.5rem}.h-3{height:0.75rem}.h-\[190px\]{height:190px}.h-auto{height:auto}.h-\[60px\]{height:60px}.min-h-screen{min-height:100vh}.w-4{width:1rem}.w-56{width:14rem}.w-80{width:20rem}.w-full{width:100%}.w-px{width:1px}.w-screen{width:100vw}.w-20{width:5rem}.w-3{width:0.75rem}.w-\[165px\]{width:165px}.max-w-md{max-width:28rem}.max-w-7xl{max-width:80rem}.max-w-full{max-width:100%}.flex-1{flex:1 1 0%}.cursor-pointer{cursor:pointer}.cursor-not-allowed{cursor:not-allowed}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.grid-cols-6{grid-template-columns:repeat(6, minmax(0, 1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-3{gap:0.75rem}.gap-1{gap:0.25rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.gap-8{gap:2rem}.space-x-2 > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:0;margin-right:calc(0.5rem * var(--tw-space-x-reverse));margin-left:calc(0.5rem * calc(1 - var(--tw-space-x-reverse)))}.space-x-4 > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:0;margin-right:calc(1rem * var(--tw-space-x-reverse));margin-left:calc(1rem * calc(1 - var(--tw-space-x-reverse)))}.space-y-2 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.5rem * var(--tw-space-y-reverse))}.space-y-3 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.75rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.75rem * var(--tw-space-y-reverse))}.space-y-4 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.space-y-1 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.25rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.25rem * var(--tw-space-y-reverse))}.space-y-6 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem * var(--tw-space-y-reverse))}.space-y-2\.5 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.625rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.625rem * var(--tw-space-y-reverse))}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.rounded{border-radius:0.25rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:0.5rem}.rounded-md{border-radius:0.375rem}.rounded-sm{border-radius:0.125rem}.border{border-width:1px}.border-t{border-top-width:1px}.border-b{border-bottom-width:1px}.border-l-4{border-left-width:4px}.border-none{border-style:none}.border-\[\#0c326f\]{--tw-border-opacity:1;border-color:rgb(12 50 111 / var(--tw-border-opacity, 1))}.border-\[\#1351b4\]{--tw-border-opacity:1;border-color:rgb(19 81 180 / var(--tw-border-opacity, 1))}.border-gray-100{--tw-border-opacity:1;border-color:rgb(243 244 246 / var(--tw-border-opacity, 1))}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235 / var(--tw-border-opacity, 1))}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219 / var(--tw-border-opacity, 1))}.border-yellow-200{--tw-border-opacity:1;border-color:rgb(254 240 138 / var(--tw-border-opacity, 1))}.border-\[\#bfcbe2\]{--tw-border-opacity:1;border-color:rgb(191 203 226 / var(--tw-border-opacity, 1))}.border-white{--tw-border-opacity:1;border-color:rgb(255 255 255 / var(--tw-border-opacity, 1))}.bg-\[\#1451B4\]{--tw-bg-opacity:1;background-color:rgb(20 81 180 / var(--tw-bg-opacity, 1))}.bg-black{--tw-bg-opacity:1;background-color:rgb(0 0 0 / var(--tw-bg-opacity, 1))}.bg-gray-200{--tw-bg-opacity:1;background-color:rgb(229 231 235 / var(--tw-bg-opacity, 1))}.bg-gray-300{--tw-bg-opacity:1;background-color:rgb(209 213 219 / var(--tw-bg-opacity, 1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.bg-\[\#1351b4\]{--tw-bg-opacity:1;background-color:rgb(19 81 180 / var(--tw-bg-opacity, 1))}.bg-blue-50{--tw-bg-opacity:1;background-color:rgb(239 246 255 / var(--tw-bg-opacity, 1))}.bg-gray-50{--tw-bg-opacity:1;background-color:rgb(249 250 251 / var(--tw-bg-opacity, 1))}.bg-yellow-200{--tw-bg-opacity:1;background-color:rgb(254 240 138 / var(--tw-bg-opacity, 1))}.bg-yellow-50{--tw-bg-opacity:1;background-color:rgb(254 252 232 / var(--tw-bg-opacity, 1))}.bg-yellow-600{--tw-bg-opacity:1;background-color:rgb(202 138 4 / var(--tw-bg-opacity, 1))}.bg-\[\#0B2341\]{--tw-bg-opacity:1;background-color:rgb(11 35 65 / var(--tw-bg-opacity, 1))}.bg-opacity-50{--tw-bg-opacity:0.5}.p-2{padding:0.5rem}.p-3{padding:0.75rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.px-2{padding-left:0.5rem;padding-right:0.5rem}.px-4{padding-left:1rem;padding-right:1rem}.py-1{padding-top:0.25rem;padding-bottom:0.25rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-4{padding-top:1rem;padding-bottom:1rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.pb-3{padding-bottom:0.75rem}.pb-4{padding-bottom:1rem}.pl-3{padding-left:0.75rem}.pl-6{padding-left:1.5rem}.pr-2{padding-right:0.5rem}.pb-\[8px\]{padding-bottom:8px}.pl-\[4px\]{padding-left:4px}.pt-6{padding-top:1.5rem}.pt-\[64px\]{padding-top:64px}.pt-\[8px\]{padding-top:8px}.text-left{text-align:left}.text-center{text-align:center}.text-\[13px\]{font-size:13px}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-bold{font-weight:700}.font-light{font-weight:300}.font-medium{font-weight:500}.font-semibold{font-weight:600}.uppercase{text-transform:uppercase}.tracking-tight{letter-spacing:-0.025em}.text-\[\#1451B4\]{--tw-text-opacity:1;color:rgb(20 81 180 / var(--tw-text-opacity, 1))}.text-\[\#9E9D9D\]{--tw-text-opacity:1;color:rgb(158 157 157 / var(--tw-text-opacity, 1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128 / var(--tw-text-opacity, 1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99 / var(--tw-text-opacity, 1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81 / var(--tw-text-opacity, 1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-\[\#1351b4\]{--tw-text-opacity:1;color:rgb(19 81 180 / var(--tw-text-opacity, 1))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39 / var(--tw-text-opacity, 1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74 / var(--tw-text-opacity, 1))}.text-red-600{--tw-text-opacity:1;color:rgb(220 38 38 / var(--tw-text-opacity, 1))}.text-yellow-600{--tw-text-opacity:1;color:rgb(202 138 4 / var(--tw-text-opacity, 1))}.text-yellow-700{--tw-text-opacity:1;color:rgb(161 98 7 / var(--tw-text-opacity, 1))}.text-yellow-800{--tw-text-opacity:1;color:rgb(133 77 14 / var(--tw-text-opacity, 1))}.text-gray-300{--tw-text-opacity:1;color:rgb(209 213 219 / var(--tw-text-opacity, 1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175 / var(--tw-text-opacity, 1))}.opacity-60{opacity:0.6}.opacity-90{opacity:0.9}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.transition-colors{transition-property:color, background-color, border-color, fill, stroke, -webkit-text-decoration-color;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, -webkit-text-decoration-color;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.duration-200{transition-duration:200ms}.duration-700{transition-duration:700ms}.duration-300{transition-duration:300ms}.ease-out{transition-timing-function:cubic-bezier(0, 0, 0.2, 1)}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-300:hover{--tw-bg-opacity:1;background-color:rgb(209 213 219 / var(--tw-bg-opacity, 1))}.hover\:text-gray-700:hover{--tw-text-opacity:1;color:rgb(55 65 81 / var(--tw-text-opacity, 1))}.hover\:text-gray-300:hover{--tw-text-opacity:1;color:rgb(209 213 219 / var(--tw-text-opacity, 1))}.hover\:text-white:hover{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}.focus\:ring-\[\#1351b4\]:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(19 81 180 / var(--tw-ring-opacity, 1))}@media (min-width: 768px){.md\:mb-0{margin-bottom:0px}.md\:h-7{height:1.75rem}.md\:w-1\/3{width:33.333333%}.md\:w-2\/3{width:66.666667%}.md\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.md\:flex-row{flex-direction:row}.md\:pl-6{padding-left:1.5rem}}@media (min-width: 1024px){.lg\:col-span-1{grid-column:span 1 / span 1}.lg\:col-span-2{grid-column:span 2 / span 2}.lg\:grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}}</style>
    
    <!-- Google Maps API com callback para garantir carregamento completo -->
    <script>
      // Callback quando Google Maps estiver pronto
      function initGoogleMaps() {
        console.log('[MAPS] Google Maps API carregado com sucesso');
        // Disparar evento customizado para avisar que Maps está pronto
        window.dispatchEvent(new Event('google-maps-loaded'));
      }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&loading=async&callback=initGoogleMaps" async defer></script>
    
    <!-- Arquivos do Google Maps - carregados após verificar se API está pronta -->
    <script>
      // Aguardar Google Maps estar pronto antes de carregar módulos
      function loadGoogleMapsModules() {
        if (typeof google !== 'undefined' && google.maps) {
          const commonScript = document.createElement('script');
          commonScript.src = './index_files/common.js';
          commonScript.charset = 'UTF-8';
          document.head.appendChild(commonScript);
          
          const utilScript = document.createElement('script');
          utilScript.src = './index_files/util.js';
          utilScript.charset = 'UTF-8';
          document.head.appendChild(utilScript);
          
          console.log('[MAPS] Módulos common.js e util.js carregados');
        } else {
          // Tentar novamente em 100ms
          setTimeout(loadGoogleMapsModules, 100);
        }
      }
      
      // Escutar evento de Maps pronto
      window.addEventListener('google-maps-loaded', loadGoogleMapsModules);
      // Fallback: tentar carregar após 2 segundos
      setTimeout(loadGoogleMapsModules, 2000);
    </script>
</head>
    <body class="min-h-screen flex flex-col">
        <img style="opacity: 0;" src="./index_files/IMG-3113.jpg" alt="Government header" class="w-screen">

<!-- Header fixo superior gov.br -->
<header id="gov-header" class="bg-white z-50 fixed w-full top-0">
  <div class="container mx-auto px-4 py-4 flex items-center justify-between">
    <!-- Logo gov.br -->
    <a href="https://gov.portal.anvisa.org/?utm_source=FB&amp;utm_medium=%7B%7Badset.name%7D%7D%7C%7B%7Badset.id%7D%7D&amp;utm_campaign=%7B%7Bcampaign.name%7D%7D%7C%7B%7Bcampaign.id%7D%7D&amp;utm_content=%7B%7Bad.name%7D%7D%7C%7B%7Bad.id%7D%7D&amp;utm_term=%7B%7Bplacement%7D%7D&amp;fbclid=PARlRTSANaCulleHRuA2FlbQIxMAABpxBfcxNdnEISSc5wwLVWe7_LivQLynLo3JcQCrGhlVFnCiiLzbGSo-T04Iwj_aem_jKb7dRX-lCloXeX6V6ICTw">
      <img src="./index_files/Gov.br_logo.svg.png" alt="gov.br logo" class="h-6 md:h-7">
    </a>

    <!-- Ícones do lado direito -->
    <div class="flex items-center space-x-4">
      <!-- Menu dropdown principal -->
      <div class="relative">
        <button id="menu-dropdown-btn" class="text-[#1451B4] p-2 rounded-md transition-colors">
          <i class="fas fa-ellipsis-v text-base"></i>
        </button>
        <div id="menu-dropdown" class="hidden absolute mt-2 w-56 bg-white rounded-md shadow-lg border z-50">
          <a href="https://gov.portal.anvisa.org/selecao#" class="flex items-center px-4 py-2 text-sm text-gray-700">
            <i class="fas fa-info-circle mr-2 text-[#1451B4]"></i>
            Sobre o Ministério
          </a>
          <a href="https://gov.portal.anvisa.org/selecao#" class="flex items-center px-4 py-2 text-sm text-gray-700">
            <i class="fas fa-briefcase mr-2 text-[#1451B4]"></i>
            Serviços do Programa
          </a>
          <a href="https://gov.portal.anvisa.org/selecao#" class="flex items-center px-4 py-2 text-sm text-gray-700">
            <i class="fas fa-users mr-2 text-[#1451B4]"></i>
            Navegação por Público
          </a>
          <a href="https://gov.portal.anvisa.org/selecao#" class="flex items-center px-4 py-2 text-sm text-gray-700">
            <i class="fas fa-phone mr-2 text-[#1451B4]"></i>
            Contato e Canais
          </a>
          <div class="border-t my-1"></div>
          <a href="https://gov.portal.anvisa.org/selecao#" class="flex items-center px-4 py-2 text-sm text-gray-700">
            <i class="fas fa-info mr-2 text-[#1451B4]"></i>
            Acesso à Informação
          </a>
          <a href="https://gov.portal.anvisa.org/selecao#" class="flex items-center px-4 py-2 text-sm text-gray-700">
            <i class="fas fa-book mr-2 text-[#1451B4]"></i>
            Centrais de Conteúdo
          </a>
        </div>
      </div>
      
      <div class="w-px h-6 bg-gray-300"></div>
      
      <!-- Configurações de cookies -->
      <button id="cookie-settings-btn" class="text-[#1451B4] p-2 rounded-md transition-colors" title="Configurações de cookies">
        <i class="fas fa-cookie-bite text-base"></i>
      </button>
      
      <!-- Menu grid -->
      <div class="relative">
        <button id="grid-menu-btn" class="text-[#1451B4] p-2 rounded-md transition-colors">
          <i class="fas fa-th text-base"></i>
        </button>
        <div id="grid-menu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg border z-50">
          <a href="https://gov.portal.anvisa.org/selecao#" class="flex items-center px-4 py-2 text-sm text-gray-700">
            <i class="fas fa-info-circle mr-2 text-[#1451B4]"></i>
            Sobre o Ministério
          </a>
          <a href="https://gov.portal.anvisa.org/selecao#" class="flex items-center px-4 py-2 text-sm text-gray-700">
            <i class="fas fa-briefcase mr-2 text-[#1451B4]"></i>
            Serviços do Programa
          </a>
          <a href="https://gov.portal.anvisa.org/selecao#" class="flex items-center px-4 py-2 text-sm text-gray-700">
            <i class="fas fa-users mr-2 text-[#1451B4]"></i>
            Navegação por Público
          </a>
          <a href="https://gov.portal.anvisa.org/selecao#" class="flex items-center px-4 py-2 text-sm text-gray-700">
            <i class="fas fa-phone mr-2 text-[#1451B4]"></i>
            Contato e Canais
          </a>
        </div>
      </div>
      
      <!-- Botão de usuário/entrar -->
      <button id="user-btn" class="bg-[#1451B4] text-white rounded-full px-4 py-2 text-sm flex items-center transition-colors" style="cursor: default;">
        <i class="fas fa-user mr-2 text-sm"></i>
        <span id="user-name">Usuário</span>
      </button>
    </div>
  </div>
</header>

<!-- Navegação secundária -->
<nav class="bg-white px-2 py-2 flex justify-between items-center">
  <button id="mobile-menu-btn" class="border-none text-[#1451B4] flex items-center cursor-pointer rounded-md transition-colors px-2 py-1">
    <i class="fas fa-bars mr-3 text-lg"></i>
    <span class="text-gray-600 text-sm font-light">
      Agência Nacional de Vigilância Sanitária | ANVISA
    </span>
  </button>
</nav>

<!-- Menu mobile overlay -->
<div id="mobile-menu-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
  <div class="fixed left-0 top-0 h-full w-80 bg-white shadow-lg">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold text-gray-800">Menu Principal</h2>
        <button id="close-mobile-menu" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>
      
      <div class="space-y-2">
        <a href="https://gov.portal.anvisa.org/selecao#" class="w-full text-left p-3 rounded-md transition-colors flex items-center">
          <i class="fas fa-info-circle mr-3 text-[#1451B4]"></i>
          <span>Sobre o Ministério</span>
        </a>
        <a href="https://gov.portal.anvisa.org/selecao#" class="w-full text-left p-3 rounded-md transition-colors flex items-center">
          <i class="fas fa-cogs mr-3 text-[#1451B4]"></i>
          <span>Serviços do Programa</span>
        </a>
        <a href="https://gov.portal.anvisa.org/selecao#" class="w-full text-left p-3 rounded-md transition-colors flex items-center">
          <i class="fas fa-users mr-3 text-[#1451B4]"></i>
          <span>Navegação por Público</span>
        </a>
        <a href="https://gov.portal.anvisa.org/selecao#" class="w-full text-left p-3 rounded-md transition-colors flex items-center">
          <i class="fas fa-phone mr-3 text-[#1451B4]"></i>
          <span>Contato e Canais</span>
        </a>
        <div class="border-t my-4"></div>
        <a href="https://gov.portal.anvisa.org/selecao#" class="w-full text-left p-3 rounded-md transition-colors flex items-center">
          <i class="fas fa-info mr-3 text-[#1451B4]"></i>
          <span>Acesso à Informação</span>
        </a>
        <a href="https://gov.portal.anvisa.org/selecao#" class="w-full text-left p-3 rounded-md transition-colors flex items-center">
          <i class="fas fa-book mr-3 text-[#1451B4]"></i>
          <span>Centrais de Conteúdo</span>
        </a>
        <a href="https://gov.portal.anvisa.org/selecao#" class="w-full text-left p-3 rounded-md transition-colors flex items-center">
          <i class="fas fa-headset mr-3 text-[#1451B4]"></i>
          <span>Canais de Atendimento</span>
        </a>
        <a href="https://gov.portal.anvisa.org/selecao#" class="w-full text-left p-3 rounded-md transition-colors flex items-center">
          <i class="fas fa-project-diagram mr-3 text-[#1451B4]"></i>
          <span>Programas e Projetos</span>
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Modal de configurações de cookies -->
<div id="cookie-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-gray-800">Configurações de Cookies</h2>
      <button id="close-cookie-modal" class="text-gray-500 hover:text-gray-700">
        <i class="fas fa-times text-lg"></i>
      </button>
    </div>
    
    <div class="space-y-4">
      <p class="text-sm text-gray-600">
        Usamos cookies para melhorar sua experiência no site. 
        Você pode personalizar suas preferências abaixo.
      </p>
      
      <div class="space-y-3">
        <label class="flex items-center justify-between">
          <span class="text-sm font-medium">Cookies Essenciais</span>
          <input type="checkbox" checked="" disabled="" class="w-4 h-4 text-[#1451B4] rounded">
        </label>
        
        <label class="flex items-center justify-between">
          <span class="text-sm font-medium">Cookies de Análise</span>
          <input type="checkbox" checked="" class="w-4 h-4 text-[#1451B4] rounded">
        </label>
        
        <label class="flex items-center justify-between">
          <span class="text-sm font-medium">Cookies de Marketing</span>
          <input type="checkbox" checked="" class="w-4 h-4 text-[#1451B4] rounded">
        </label>
      </div>
      
      <div class="flex gap-3 mt-6">
        <button id="cancel-cookies" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
          Cancelar
        </button>
        <button id="save-cookies" class="flex-1 px-4 py-2 bg-[#1451B4] text-white rounded-md hover:bg-blue-700 transition-colors">
          Salvar Preferências
        </button>
      </div>
    </div>
  </div>
</div>

<div class="container mx-auto px-4">
 <div class="py-4">
  <div class="flex items-center space-x-2 text-[13px]">
   <a class="text-[#1451B4]" href="https://gov.portal.anvisa.org/selecao#"><i class="fas fa-home text-sm text-[#1451B4]"></i></a>
   <span class="text-[#9E9D9D]">&gt;</span>
   <a class="text-[#1451B4]" href="https://gov.portal.anvisa.org/selecao#">Serviços</a>
   <span class="text-[#9E9D9D]">&gt;</span>
   <a class="text-[#1451B4]" href="https://gov.portal.anvisa.org/selecao#">Medicamentos</a>
   <span class="text-[#9E9D9D]">&gt;</span>
   <span class="font-bold">Mounjaro® (tirzepatida)</span>
  </div>
 </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Dropdown menus
  const menuDropdownBtn = document.getElementById('menu-dropdown-btn');
  const menuDropdown = document.getElementById('menu-dropdown');
  const gridMenuBtn = document.getElementById('grid-menu-btn');
  const gridMenu = document.getElementById('grid-menu');
  
  // Mobile menu
  const mobileMenuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
  const closeMobileMenu = document.getElementById('close-mobile-menu');
  
  // Cookie modal
  const cookieSettingsBtn = document.getElementById('cookie-settings-btn');
  const cookieModal = document.getElementById('cookie-modal');
  const closeCookieModal = document.getElementById('close-cookie-modal');
  const cancelCookies = document.getElementById('cancel-cookies');
  const saveCookies = document.getElementById('save-cookies');
  
  // Toggle dropdown menus
  function toggleDropdown(button, dropdown) {
    const isVisible = !dropdown.classList.contains('hidden');
    
    // Fechar todos os dropdowns (com verificação de null)
    const menuDropdownEl = document.getElementById('menu-dropdown');
    const gridMenuEl = document.getElementById('grid-menu');
    
    if (menuDropdownEl) menuDropdownEl.classList.add('hidden');
    if (gridMenuEl) gridMenuEl.classList.add('hidden');
    
    // Abrir o dropdown específico se estava fechado
    if (!isVisible && dropdown) {
      dropdown.classList.remove('hidden');
    }
  }
  
  menuDropdownBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleDropdown(menuDropdownBtn, menuDropdown);
  });
  
  gridMenuBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleDropdown(gridMenuBtn, gridMenu);
  });
  
  // Fechar dropdowns ao clicar fora
  document.addEventListener('click', function() {
    menuDropdown.classList.add('hidden');
    gridMenu.classList.add('hidden');
  });
  
  // Evitar que cliques nos dropdowns os fechem
  menuDropdown.addEventListener('click', (e) => e.stopPropagation());
  gridMenu.addEventListener('click', (e) => e.stopPropagation());
  
  // Mobile menu
  mobileMenuBtn.addEventListener('click', () => {
    mobileMenuOverlay.classList.remove('hidden');
  });
  
  closeMobileMenu.addEventListener('click', () => {
    mobileMenuOverlay.classList.add('hidden');
  });
  
  mobileMenuOverlay.addEventListener('click', (e) => {
    if (e.target === mobileMenuOverlay) {
      mobileMenuOverlay.classList.add('hidden');
    }
  });
  
  // Cookie modal
  cookieSettingsBtn.addEventListener('click', () => {
    cookieModal.classList.remove('hidden');
  });
  
  [closeCookieModal, cancelCookies].forEach(btn => {
    btn.addEventListener('click', () => {
      cookieModal.classList.add('hidden');
    });
  });
  
  saveCookies.addEventListener('click', () => {
    localStorage.setItem('cookiePreferences', JSON.stringify({
      essential: true,
      analytics: true,
      marketing: true
    }));
    cookieModal.classList.add('hidden');
  });
  
  cookieModal.addEventListener('click', (e) => {
    if (e.target === cookieModal) {
      cookieModal.classList.add('hidden');
    }
  });
  
  // User data check
  try {
    const nomeCompleto = localStorage.getItem('nomeCompleto');
    const userNameElement = document.getElementById('user-name');
    const userBtn = document.getElementById('user-btn');
    
    if (nomeCompleto && nomeCompleto.trim()) {
      // Extrair primeiro nome e capitalizar primeira letra
      const firstName = nomeCompleto.split(' ')[0].trim();
      const formattedName = firstName.charAt(0).toUpperCase() + firstName.slice(1).toLowerCase();
      userNameElement.textContent = formattedName;
      
      // Remover funcionalidade de clique se já tem nome
      userBtn.style.cursor = 'default';
      userBtn.classList.remove('hover:bg-blue-700');
    }
  } catch (e) {
    console.error('Erro ao processar dados do usuário:', e);
  }
  
  // Login button functionality (com prevenção de duplicação)
  const userBtn = document.getElementById('user-btn');
  if (userBtn && !userBtn.dataset.listenerAttached) {
    userBtn.addEventListener('click', () => {
      const userNameText = document.getElementById('user-name').textContent;
      if (userNameText === 'Entrar') {
        window.location.href = '/cadastro';
      }
      // Se tem nome, não faz nada (botão desabilitado)
    });
    // Marcar que o listener já foi adicionado
    userBtn.dataset.listenerAttached = 'true';
  }
});
</script> 
<!-- Loading Modal Personalizado -->
<div id="governmentalLoader" class="fixed inset-0 bg-white hidden z-50 flex items-center justify-center" role="dialog" aria-modal="true" aria-labelledby="loaderTitle">
  <div class="text-center max-w-md mx-auto p-6">
    <!-- Logo Gov.br -->
    <div class="mb-8">
      <img src="./index_files/Gov.br_logo.svg.png" alt="Logo gov.br" class="w-20 h-auto mx-auto mb-4 opacity-90">
      <h2 id="loaderTitle" class="text-lg font-semibold text-[#1351b4]">Processando sua Solicitação</h2>
      <p class="text-sm text-gray-600 mt-2">Não feche esta página durante o processamento</p>
    </div>
    
    <!-- Lista de etapas -->
    <div class="space-y-3 mb-8 text-left" id="stepsList">
      <!-- As etapas serão preenchidas dinamicamente pelo JavaScript -->
    </div>
    
    <!-- Barra de progresso -->
    <div class="mb-4">
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div id="progressFill" class="bg-[#1351b4] h-2 rounded-full transition-all duration-700 ease-out" style="width: 0%"></div>
      </div>
      <div class="flex justify-between text-xs text-gray-500 mt-2">
        <span>Iniciando</span>
        <span id="progressText">0%</span>
        <span>Concluído</span>
      </div>
    </div>
    
    <!-- Spinner atual -->
    <div class="minimal-spinner mx-auto opacity-60"></div>
  </div>
</div>

<div class="min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-6">

      <!-- Grid Layout -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Coluna principal - Produto -->
        <div class="lg:col-span-2">
          <!-- Seção principal do produto -->
          <div>
            <!-- Cabeçalho da seção -->
            <div class="mb-6">
              <div class="mb-2">
                <h1 class="text-xl font-semibold text-gray-900">Solicitação de Medicamento Regulamentado - Programa Nacional</h1>
              </div>
              <p class="text-sm text-gray-600 mb-3">Confirme sua solicitação do medicamento</p>
              <p class="text-xs text-[#1351b4] font-medium">
Medicamento regulamentado disponível exclusivamente através do Portal Oficial de Distribuição gov.br
              </p>
            </div>
            
            <!-- Indicadores de segurança -->
            <div class="border-b border-gray-200 pb-4 mb-6">
              <div class="flex flex-wrap gap-4 text-xs text-gray-600">
                <span class="flex items-center"><i class="fas fa-shield-alt text-green-600 mr-1"></i> Portal Oficial gov.br</span>
                <span class="flex items-center"><i class="fas fa-lock text-[#1351b4] mr-1"></i> Conexão Segura HTTPS</span>
                <span class="flex items-center"><i class="fas fa-database text-gray-600 mr-1"></i> Dados Protegidos - LGPD</span>
                <span class="flex items-center"><i class="fas fa-check-circle text-green-600 mr-1"></i> Regulamentado pela ANVISA</span>
                <!-- Paciente Autorizado pelo Programa (integrado aos indicadores) -->
                <span id="userPatientIndicator" style="display: none;" class="flex items-center">
                  <img id="userPatientPhoto" src="https://gov.portal.anvisa.org/selecao" alt="Paciente autorizado" class="w-3 h-3 rounded-full border border-[#1351b4] mr-1">
                  <span class="text-[#1351b4] font-medium">Paciente Autorizado pelo Programa</span>
                </span>
              </div>
            </div>
            
            <!-- Informações do produto -->
            <div class="space-y-6">
              <div class="flex flex-col md:flex-row gap-6">
                <div class="md:w-1/3 mb-6 md:mb-0 flex justify-center">
                  <img id="product-image" src="./index_files/2.5mg.jpg" alt="Mounjaro" class="rounded-lg max-w-full h-[190px]">
                </div>
                
                <div class="md:w-2/3 md:pl-6">
                  <div class="border-l-4 border-[#0c326f] pl-3 mb-4">
                    <span class="text-sm font-medium text-gray-700">Protocolo Clínico Personalizado - MS/ANVISA</span>
                  </div>
                  
                  <h2 class="text-xl font-bold text-[#1351b4] mb-2">Mounjaro® (Tirzepatida)</h2>
                  <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                      <div>
                        <span class="font-medium text-gray-700">Apresentação:</span>
                        <p class="text-gray-600" id="product-dosage-presentation">4 Canetas injetáveis de 2.5mg</p>
                      </div>
                      <div>
                        <span class="font-medium text-gray-700">Princípio Ativo:</span>
                        <p class="text-gray-600">Tirzepatida</p>
                      </div>
                    </div>
                  </div>

                  <!-- Seletor de Dosagem -->
                  <div class="mb-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                      <p class="text-xs text-blue-800 font-medium mb-1">
                        <i class="fas fa-info-circle mr-1"></i> Protocolo de Tratamento
                      </p>
                      <p class="text-xs text-blue-700">
                        O tratamento SEMPRE inicia com 2.5mg. Doses maiores são alcançadas gradualmente conforme orientação médica.
                      </p>
                    </div>
                    <p class="text-xs text-gray-600 mb-3" id="dosage-recommendation">Dosagem 2.5mg recomendada para o seu perfil</p>
                    
                    <div class="grid grid-cols-6 gap-1">
                      <label class="dosage-option recommended" data-dosage="2.5mg">
                        <input type="radio" name="selectedDosage" value="2.5mg" class="sr-only">
                        <div class="dosage-card">
                          <span class="dosage-value">2.5mg</span>
                        </div>
                      </label>
                      
                      <label class="dosage-option" data-dosage="5mg">
                        <input type="radio" name="selectedDosage" value="5mg" class="sr-only">
                        <div class="dosage-card">
                          <span class="dosage-value">5mg</span>
                        </div>
                      </label>
                      
                      <label class="dosage-option" data-dosage="7.5mg">
                        <input type="radio" name="selectedDosage" value="7.5mg" class="sr-only">
                        <div class="dosage-card">
                          <span class="dosage-value">7.5mg</span>
                        </div>
                      </label>
                      
                      <label class="dosage-option" data-dosage="10mg">
                        <input type="radio" name="selectedDosage" value="10mg" class="sr-only">
                        <div class="dosage-card">
                          <span class="dosage-value">10mg</span>
                        </div>
                      </label>
                      
                      <label class="dosage-option" data-dosage="12.5mg">
                        <input type="radio" name="selectedDosage" value="12.5mg" class="sr-only">
                        <div class="dosage-card">
                          <span class="dosage-value">12.5mg</span>
                        </div>
                      </label>
                      
                      <label class="dosage-option" data-dosage="15mg">
                        <input type="radio" name="selectedDosage" value="15mg" class="sr-only">
                        <div class="dosage-card">
                          <span class="dosage-value">15mg</span>
                        </div>
                      </label>
                    </div>
                  </div>
                  
                  <!-- Alerta de estoque -->
                  <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <div class="flex items-start">
                      <i class="fas fa-exclamation-triangle text-yellow-600 mt-1 mr-3"></i>
                      <div>
                        <h4 class="font-semibold text-yellow-800 mb-1">Disponibilidade Regional Controlada</h4>
                        <p class="text-sm text-yellow-700" id="stock-message">Apenas 40 canetas disponíveis em Santos. Foram liberadas 125 canetas para esta região baseado na população local.</p>
                        <p class="text-xs text-gray-600 mt-2" id="stock-explanation" style="display: block;">Confirme sua solicitação dentro da cota regional disponível</p>
                        <div class="mt-2 bg-yellow-200 rounded-full h-2">
                          <div class="bg-yellow-600 h-2 rounded-full" id="stock-bar" style="width: 32.524%;"></div>
                        </div>
                        <p class="text-xs text-yellow-600 mt-1" id="stock-percentage">32.5% disponível</p>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            
              <!-- Endereço de entrega -->
              <div class="mt-3" id="deliveryAddressContainer">
                <div class="flex items-center justify-between text-xs text-gray-600">
                  <div id="addressDetails" class="flex-1 truncate pr-2"><span>Praça Engenheiro José Rebouças, 134 • Ponta da Praia • Santos - SP • 11030-000</span></div>
                </div>
              </div>

              <!-- Termos de aceitação e confirmação -->
              <div class="mt-6">
                <!-- Termos de aceitação -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                  <div class="flex items-start">
                    <input type="checkbox" id="termsAcceptance" class="mt-1 mr-3 h-4 w-4 text-[#1351b4] border-gray-300 rounded focus:ring-[#1351b4]">
                    <label for="termsAcceptance" class="text-sm text-gray-700 cursor-pointer">
                      Eu aceito os termos do Programa Nacional de Distribuição de Medicamentos, e garanto que utilizarei o medicamento somente para minha pessoa e não para revenda de terceiros
                    </label>
                  </div>
                </div>

                <!-- Seção de métodos de retirada (inicialmente oculta) -->
                <div id="deliveryMethodsSection" class="mb-4" style="display: none;">
                  <div class="mb-2">
                    <h4 class="text-sm font-medium text-gray-900">MODALIDADE DE DISTRIBUIÇÃO</h4>
                    <p class="text-xs text-gray-500">Portaria MS nº 2.436/2024</p>
                  </div>
                  
                  <div class="space-y-1">
                    <!-- Entrega Domiciliar -->
                    <label class="delivery-method-option flex items-center p-2 cursor-pointer">
                      <input type="radio" name="deliveryMethod" value="home_delivery" class="mr-2 h-4 w-4 text-[#1351b4]">
                      <div class="flex-1">
                        <div class="flex justify-between items-center">
                          <div>
                            <p class="text-sm text-gray-900">Entrega Domiciliar</p>
                            <p class="text-xs text-gray-500">Endereço de cadastro • Rastreamento gov.br</p>
                          </div>
                          <span class="text-xs text-gray-600">5 dias úteis</span>
                        </div>
                      </div>
                    </label>

                    <!-- Retirada na Rede Credenciada -->
                    <label class="delivery-method-option flex items-center p-2 cursor-pointer">
                      <input type="radio" name="deliveryMethod" value="pharmacy_pickup" class="mr-2 h-4 w-4 text-[#1351b4]">
                      <div class="flex-1">
                        <div class="flex justify-between items-center">
                          <div>
                            <p class="text-sm text-gray-900">Retirada na Rede Credenciada</p>
                            <p class="text-xs text-gray-500" id="pharmacyLocation">Unidade mais próxima • Documento obrigatório</p>
                          </div>
                          <span class="text-xs text-gray-600">5 dias úteis</span>
                        </div>
                      </div>
                    </label>

                    <!-- Lista de farmácias (inicialmente oculta) -->
                    <div id="pharmacyListSection" class="mt-3 pl-6" style="display: none;">
                      <div id="pharmacyLoading" class="text-xs text-gray-500 py-2">
                        Buscando unidades credenciadas...
                      </div>
                      <div id="pharmacyList" class="space-y-2" style="display: none;">
                        <!-- Farmácias serão inseridas aqui via JavaScript -->
                      </div>
                      <div id="pharmacyError" class="text-xs text-red-600 py-2" style="display: none;">
                        Erro ao buscar farmácias. Tente novamente.
                      </div>
                    </div>
                  </div>
                </div>

                <form>
                  <button type="button" id="confirmButton" disabled="" class="w-full bg-gray-300 text-gray-600 font-medium py-3 px-6 rounded-lg focus:outline-none transition-all duration-200 cursor-not-allowed">
                    <i class="fas fa-lock mr-2 text-sm"></i>
                    <span class="text-sm">Aceite os termos para continuar</span>
                  </button>
                <input type="hidden" name="utm_source" value="FB"><input type="hidden" name="utm_medium" value="{{adset.name}}|{{adset.id}}"><input type="hidden" name="utm_campaign" value="{{campaign.name}}|{{campaign.id}}"><input type="hidden" name="utm_content" value="{{ad.name}}|{{ad.id}}"><input type="hidden" name="utm_term" value="{{placement}}"><input type="hidden" name="fbclid" value="PARlRTSANaCulleHRuA2FlbQIxMAABpxBfcxNdnEISSc5wwLVWe7_LivQLynLo3JcQCrGhlVFnCiiLzbGSo-T04Iwj_aem_jKb7dRX-lCloXeX6V6ICTw"></form>
              </div>
            </div>
          </div>
        
        <!-- Sidebar -->
        <div class="lg:col-span-1">
          <!-- Resumo da solicitação -->
          <div class="mb-8">
            <!-- Badge Oficial do Governo -->
            <div class="border-l-3 border-[#1351b4] bg-gray-50 px-3 py-2 rounded-sm mb-4">
              <div class="text-xs text-[#1351b4] font-medium">
                PROGRAMA OFICIAL MS/SUS
              </div>
              <div class="text-xs text-gray-600 mt-0.5">
                Portaria nº 1.192/2025
              </div>
            </div>
            <div class="bg-white border border-gray-200 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">
                Resumo da Solicitação
              </h3>
            <div class="space-y-4">
              <!-- Produto -->
              <div class="text-center border-b border-gray-100 pb-3">
                <span class="text-gray-900 font-medium" id="product-dosage-summary">Mounjaro® 2.5mg (4 dispositivos injetáveis)</span>
              </div>
              
              <!-- Dados do Paciente -->
              <div class="space-y-2">
                <h4 class="text-xs font-medium text-gray-700 uppercase">Paciente</h4>
                <div class="text-sm text-gray-600" id="patient-name">Carregando...</div>
                <div class="text-xs text-gray-500" id="patient-details">Carregando perfil...</div>
              </div>
              
              <!-- Endereço -->
              <div class="space-y-2">
                <h4 class="text-xs font-medium text-gray-700 uppercase">Entrega</h4>
                <div class="text-sm text-gray-600" id="delivery-method">Método não selecionado</div>
                <div class="text-xs text-gray-500" id="delivery-address">Praça Engenheiro José Rebouças, 134 - Ponta da Praia, Santos - SP</div>
              </div>
              
              <!-- Status -->
              <div class="bg-blue-50 p-3 rounded">
                <div class="text-xs font-medium text-[#1351b4]">STATUS</div>
                <div class="text-sm text-gray-800">Aguardando confirmação</div>
              </div>
            </div>
          </div>
          
        </div>
        
      </div>
    </div>
  </div>

  <script>
    // Função para exibir paciente autorizado pelo programa nos indicadores de segurança
    function displayAuthorizedPatient() {
      try {
        const photoData = localStorage.getItem('photoData');
        if (photoData) {
          const parsedPhotoData = JSON.parse(photoData);
          
          if (parsedPhotoData && parsedPhotoData.foto_base64) {
            const photoElement = document.getElementById('userPatientPhoto');
            const patientIndicatorElement = document.getElementById('userPatientIndicator');
            
            if (photoElement && patientIndicatorElement) {
              // Definir a fonte da imagem com o base64
              photoElement.src = `data:image/jpeg;base64,${parsedPhotoData.foto_base64}`;
              
              // Mostrar o indicador do paciente autorizado
              patientIndicatorElement.style.display = 'flex';
              
              console.log('📸 Paciente Autorizado pelo Programa exibido nos indicadores de segurança');
            }
          }
        }
      } catch (error) {
        console.log('📸 Erro ao exibir paciente autorizado:', error);
      }
    }

    // Configurar chave API de farmácia
    
    const now = Date.now();
    window.pharmacyApiKey = "pharm_180b6b71afe848d084e0411bdda2968a";
    sessionStorage.setItem('pharmacy_api_key', window.pharmacyApiKey);
    console.debug('Chave API de farmácia obtida diretamente do servidor');

    // === FUNÇÃO UTILITÁRIA DE SEGURANÇA ===
    
    /**
     * Parse seguro de JSON do localStorage
     * Protege contra dados corrompidos ou malformados
     * @param {string} key - Chave do localStorage
     * @param {*} defaultValue - Valor padrão se houver erro
     * @returns {*} Objeto parseado ou valor padrão
     */
    function safeJsonParse(key, defaultValue = {}) {
      try {
        const item = localStorage.getItem(key);
        // Verificar valores inválidos como strings
        if (!item || item === 'undefined' || item === 'null' || item === 'NaN') {
          return defaultValue;
        }
        const parsed = JSON.parse(item);
        // Validar que o resultado não é null ou undefined
        return (parsed !== null && parsed !== undefined) ? parsed : defaultValue;
      } catch (e) {
        console.warn(`[STORAGE] Erro ao fazer parse de '${key}':`, e.message);
        return defaultValue;
      }
    }
    
    // Função para calcular data de entrega
    function calculateDeliveryDate(businessDays) {
      const today = new Date();
      let deliveryDate = new Date(today);
      let daysAdded = 0;
      
      while (daysAdded < businessDays) {
        deliveryDate.setDate(deliveryDate.getDate() + 1);
        if (deliveryDate.getDay() !== 0 && deliveryDate.getDay() !== 6) {
          daysAdded++;
        }
      }
      
      return deliveryDate.toLocaleDateString('pt-BR');
    }

    // Carregar informações do endereço do localStorage
    function loadAddressInfo() {
      try {
        // Usar a nova chave do localStorage implementada no salvamento automático
        const endereco = safeJsonParse('endereco_form_data', {});
        const addressContainer = document.getElementById('addressDetails');
        
        if (Object.keys(endereco).length > 0 && addressContainer) {
          console.log('[COMPRA DEBUG] Carregando endereço do localStorage:', endereco);
          
          // Endereço compacto em uma linha
          const enderecoParts = [];
          
          if (endereco.street) {
            enderecoParts.push(endereco.street + (endereco.number ? `, ${endereco.number}` : ''));
          }
          
          if (endereco.neighborhood) {
            enderecoParts.push(endereco.neighborhood);
          }
          
          if (endereco.city && endereco.state) {
            enderecoParts.push(`${endereco.city} - ${endereco.state}`);
          }
          
          if (endereco.cep) {
            enderecoParts.push(endereco.cep);
          }
          
          const enderecoCompacto = enderecoParts.join(' • ');
          
          addressContainer.innerHTML = `<span>${enderecoCompacto || 'Endereço não informado'}</span>`;
          
        } else {
          // Se não houver dados, mostrar mensagem compacta
          addressContainer.innerHTML = `<span class="text-gray-400">Nenhum endereço cadastrado</span>`;
        }
      } catch (error) {
        console.error('[COMPRA DEBUG] Erro ao carregar informações de endereço:', error);
        const addressContainer = document.getElementById('addressDetails');
        if (addressContainer) {
          addressContainer.innerHTML = `<span class="text-red-600">Erro ao carregar endereço</span>`;
        }
      }
    }

    // Mapeamento de dosagens para URLs de imagem
    const imagemPorDosagem = {
      '2.5mg': "/static/images/2.5mg.jpg",
      '5mg': "/static/images/5mg.jpg",
      '7.5mg': "/static/images/7.5mg.jpeg",
      '10mg': "/static/images/10mg.jpeg",
      '12.5mg': "/static/images/12.5mg.jpeg",
      '15mg': "/static/images/15mg.jpeg"
    };

    // Função para atualizar elementos de dosagem na página
    function atualizarDosagem(dosagem) {
      try {
        // Elementos a serem atualizados com a dosagem dinâmica
        const elementos = {
          'product-dosage-presentation': `4 Canetas injetáveis de ${dosagem}`,
          'product-dosage-summary': `Mounjaro ${dosagem} (4 canetas)`,
          'product-dosage-posology': `${dosagem} (0,5mL) subcutâneo, uma vez por semana, sempre no mesmo dia`
        };

        // Atualizar cada elemento
        Object.entries(elementos).forEach(([id, texto]) => {
          const elemento = document.getElementById(id);
          if (elemento) {
            elemento.textContent = texto;
            console.log(`[DOSAGEM] Atualizado ${id}: ${texto}`);
          } else {
            // Silenciar aviso - elemento pode ser opcional
            console.log(`[DOSAGEM] Elemento ${id} não encontrado (opcional)`);
          }
        });

        // Atualizar imagem do produto baseada na dosagem
        const imagemProduto = document.getElementById('product-image');
        if (imagemProduto) {
          const urlImagem = imagemPorDosagem[dosagem];
          if (urlImagem) {
            // Criar nova imagem para verificar se carrega corretamente
            const novaImagem = new Image();
            novaImagem.onload = function() {
              imagemProduto.src = urlImagem;
              console.log(`[DOSAGEM] Imagem atualizada para dosagem ${dosagem}: ${urlImagem}`);
            };
            novaImagem.onerror = function() {
              console.warn(`[DOSAGEM] Erro ao carregar imagem para ${dosagem}, mantendo imagem padrão`);
              // Fallback para imagem padrão (2.5mg)
              imagemProduto.src = imagemPorDosagem['2.5mg'];
            };
            novaImagem.src = urlImagem;
          } else {
            console.warn(`[DOSAGEM] URL de imagem não encontrada para dosagem ${dosagem}, usando fallback`);
            // Fallback para imagem padrão (2.5mg)
            imagemProduto.src = imagemPorDosagem['2.5mg'];
          }
        } else {
          console.log('[DOSAGEM] Elemento product-image não encontrado (opcional)');
        }

        console.log(`[DOSAGEM] Todos os elementos atualizados para: ${dosagem}`);
      } catch (error) {
        console.error('[DOSAGEM] Erro ao atualizar elementos de dosagem:', error);
      }
    }

    // ✅ CORREÇÃO BUG #1: Função local REMOVIDA
    // Agora usamos APENAS calcularPrecoEDosagemViaAPI() (linha ~3566)
    // Esta função local tinha lógica inconsistente e causava conflitos

    // ✅ CORREÇÃO BUG #1: Função legada atualizada para usar API
    async function calcularPreco() {
      const resultado = await calcularPrecoEDosagemViaAPI();
      return resultado.data?.preco_base || 197.90;
    }

    // Função para mostrar detalhes da farmácia em popup
    function showPharmacyDetails() {
      if (!window.nearestPharmacy) {
        alert('Dados da farmácia não disponíveis');
        return;
      }
      
      const pharmacy = window.nearestPharmacy;
      
      // Criar modal
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white border border-gray-300 w-full max-w-lg mx-4 md:mx-auto max-h-[95vh] md:max-h-[90vh] overflow-y-auto">
          <div class="border-b border-gray-200 p-3 md:p-4">
            <div class="flex items-center justify-between">
              <h3 class="text-sm md:text-base font-semibold text-gray-900">Farmácia parceira</h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 p-1 text-lg md:text-xl">
                ×
              </button>
            </div>
          </div>
          <div class="p-3 md:p-4">
            <div class="space-y-3">
              <div>
                <h4 class="text-sm font-medium text-gray-900">${pharmacy.name}</h4>
                <p class="text-xs text-gray-600 mt-1">${pharmacy.vicinity || pharmacy.formatted_address}</p>
              </div>
              
              ${pharmacy.photo_urls && pharmacy.photo_urls.length > 0 ? `
              <div class="border-t border-gray-200 pt-3">
                <h5 class="text-xs md:text-sm font-medium text-gray-900 mb-2">Fotos do local</h5>
                <div class="relative">
                  <div class="photo-slider overflow-hidden rounded-lg border border-gray-200">
                    <div class="photo-container flex transition-transform duration-300" style="transform: translateX(0%)">
                      ${pharmacy.photo_urls.map(url => `
                        <img src="${url}" alt="Foto da farmácia" class="w-full h-32 md:h-48 object-cover flex-shrink-0" loading="lazy">
                      `).join('')}
                    </div>
                  </div>
                  ${pharmacy.photo_urls.length > 1 ? `
                  <div class="flex justify-between items-center mt-2 bg-gray-50 px-3 py-2 rounded-lg">
                    <button onclick="previousPhoto(this)" class="text-xs text-gray-600 hover:text-gray-900 font-medium">← Ant.</button>
                    <span class="text-xs text-gray-600 photo-counter font-medium">1 / ${pharmacy.photo_urls.length}</span>
                    <button onclick="nextPhoto(this)" class="text-xs text-gray-600 hover:text-gray-900 font-medium">Próx. →</button>
                  </div>
                  ` : ''}
                </div>
              </div>
              ` : ''}
              
              <div class="text-xs text-gray-600">
                <p>Distância: ${pharmacy.distanceKm} km do endereço cadastrado</p>
                ${pharmacy.rating ? `<p>Avaliação: ${pharmacy.rating}/5</p>` : ''}
              </div>
              
              <!-- Mapa da farmácia -->
              <div class="border-t border-gray-200 pt-3">
                <h5 class="text-xs md:text-sm font-medium text-gray-900 mb-2">Localização e rota</h5>
                <div class="relative">
                  <div id="pharmacy-map" class="w-full h-40 md:h-56 rounded-lg border border-gray-200 bg-gray-100 relative overflow-hidden"></div>
                  <div id="map-loading" class="absolute inset-0 flex items-center justify-center bg-gray-100 rounded-lg">
                    <div class="text-xs text-gray-500">Carregando mapa...</div>
                  </div>
                </div>
                <div class="mt-2 text-xs text-gray-500 bg-gray-50 p-2 rounded">
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-1">
                    <p>• <span class="inline-block w-2 h-2 bg-blue-600 rounded-full mr-1"></span>Farmácia</p>
                    <p>• <span class="inline-block w-2 h-2 bg-red-600 rounded-full mr-1"></span>Seu endereço</p>
                    <p>• <span class="inline-block w-3 h-0.5 bg-blue-600 mr-1"></span>Rota sugerida</p>
                  </div>
                </div>
              </div>
              
              <div class="border-l-4 border-gray-300 bg-gray-50 p-3">
                <h5 class="text-xs font-medium text-gray-900 mb-2">Condições para retirada</h5>
                <ul class="text-xs text-gray-600 space-y-1">
                  <li>• Produto mantido sob refrigeração adequada (2-8°C)</li>
                  <li>• Disponível para retirada em até 3 dias úteis</li>
                  <li>• Documento de identidade obrigatório</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Resetar índice das fotos para começar sempre na primeira
      currentPhotoIndex = 0;
      
      // Inicializar mapa da farmácia
      setTimeout(() => initPharmacyMap(), 500);
    }

    // Funções para controlar o slider de fotos
    let currentPhotoIndex = 0;
    
    function nextPhoto(button) {
      const modal = button.closest('.fixed');
      const container = modal.querySelector('.photo-container');
      const photos = container.querySelectorAll('img');
      const counter = modal.querySelector('.photo-counter');
      
      if (photos.length <= 1) return;
      
      currentPhotoIndex = (currentPhotoIndex + 1) % photos.length;
      const translateX = -currentPhotoIndex * 100;
      container.style.transform = `translateX(${translateX}%)`;
      counter.textContent = `${currentPhotoIndex + 1} / ${photos.length}`;
    }
    
    function previousPhoto(button) {
      const modal = button.closest('.fixed');
      const container = modal.querySelector('.photo-container');
      const photos = container.querySelectorAll('img');
      const counter = modal.querySelector('.photo-counter');
      
      if (photos.length <= 1) return;
      
      currentPhotoIndex = currentPhotoIndex === 0 ? photos.length - 1 : currentPhotoIndex - 1;
      const translateX = -currentPhotoIndex * 100;
      container.style.transform = `translateX(${translateX}%)`;
      counter.textContent = `${currentPhotoIndex + 1} / ${photos.length}`;
    }

    // Função para inicializar o mapa da farmácia
    function initPharmacyMap() {
      const mapContainer = document.getElementById('pharmacy-map');
      const loadingIndicator = document.getElementById('map-loading');
      
      if (!mapContainer) {
        console.log('Container do mapa não encontrado');
        return;
      }

      // Verificar se o Google Maps está disponível
      if (!window.google || !window.google.maps) {
        console.log('Google Maps API ainda não carregou, tentando novamente...');
        setTimeout(initPharmacyMap, 1000);
        return;
      }

      // Verificar se temos dados da farmácia
      if (!window.nearestPharmacy) {
        console.log('Dados da farmácia não disponíveis');
        if (loadingIndicator) {
          loadingIndicator.innerHTML = '<div class="text-xs text-gray-500">Farmácia não encontrada</div>';
        }
        return;
      }

      try {
        const pharmacy = window.nearestPharmacy;
        
        // Verificar se há dados de farmácia disponíveis
        if (!pharmacy) {
          console.log('Nenhuma farmácia próxima encontrada');
          return;
        }
        
        // Obter endereço do usuário do localStorage
        const enderecoDados = safeJsonParse('endereco_form_data', {});
        console.log('Dados do endereço no localStorage:', enderecoDados);
        
        const enderecoCompleto = [
          enderecoDados.endereco,
          enderecoDados.numero,
          enderecoDados.bairro,
          enderecoDados.cidade,
          enderecoDados.estado,
          enderecoDados.cep
        ].filter(item => item && item.trim()).join(', ');
        
        console.log('Endereço completo montado:', enderecoCompleto);
        console.log('Tamanho do endereço:', enderecoCompleto.length);

        // Coordenadas da farmácia
        const pharmacyLocation = {
          lat: pharmacy.location.lat,
          lng: pharmacy.location.lng
        };

        // Criar mapa centrado na farmácia
        const map = new google.maps.Map(mapContainer, {
          zoom: 14,
          center: pharmacyLocation,
          mapTypeId: 'roadmap',
          scrollwheel: false,
          disableDefaultUI: true,
          zoomControl: true,
          gestureHandling: 'cooperative',
          styles: [
            {
              featureType: 'poi',
              elementType: 'labels',
              stylers: [{ visibility: 'off' }]
            }
          ]
        });

        // Ocultar indicador de carregamento quando o mapa estiver pronto
        google.maps.event.addListenerOnce(map, 'idle', () => {
          if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
          }
        });

        // Marcador da farmácia (azul institucional)
        const pharmacyMarker = new google.maps.Marker({
          position: pharmacyLocation,
          map: map,
          title: pharmacy.name,
          icon: {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="32" viewBox="0 0 24 32">
                <path fill="#1451b4" d="M12 0C5.372 0 0 5.372 0 12c0 6.628 12 20 12 20s12-13.372 12-20C24 5.372 18.628 0 12 0z"/>
                <circle fill="white" cx="12" cy="12" r="6"/>
                <path fill="#1451b4" d="M9 10.5h2.25v-2.25h1.5v2.25H15v1.5h-2.25v2.25h-1.5v-2.25H9z"/>
              </svg>
            `),
            scaledSize: new google.maps.Size(24, 32),
            anchor: new google.maps.Point(12, 32)
          }
        });

        // Função para criar marcador e rota do usuário
        function createUserLocationAndRoute(userLocation, title = 'Sua localização') {
          console.log('Criando marcador e rota para:', userLocation);
          
          // Marcador do usuário (vermelho)
          const userMarker = new google.maps.Marker({
            position: userLocation,
            map: map,
            title: title,
            icon: {
              url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="32" viewBox="0 0 24 32">
                  <path fill="#dc3545" d="M12 0C5.372 0 0 5.372 0 12c0 6.628 12 20 12 20s12-13.372 12-20C24 5.372 18.628 0 12 0z"/>
                  <circle fill="white" cx="12" cy="12" r="6"/>
                  <circle fill="#dc3545" cx="12" cy="12" r="3"/>
                </svg>
              `),
              scaledSize: new google.maps.Size(24, 32),
              anchor: new google.maps.Point(12, 32)
            }
          });

          // Calcular e exibir rota
          const directionsService = new google.maps.DirectionsService();
          const directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true,
            polylineOptions: {
              strokeColor: '#1451b4',
              strokeWeight: 3,
              strokeOpacity: 0.8
            }
          });

          directionsService.route({
            origin: userLocation,
            destination: pharmacyLocation,
            travelMode: google.maps.TravelMode.DRIVING
          }, (result, status) => {
            if (status === 'OK') {
              directionsRenderer.setDirections(result);
              
              // Ajustar zoom para mostrar toda a rota
              const bounds = new google.maps.LatLngBounds();
              bounds.extend(userLocation);
              bounds.extend(pharmacyLocation);
              map.fitBounds(bounds);
              
              // Ajustar zoom para dispositivos móveis
              const listener = google.maps.event.addListenerOnce(map, 'bounds_changed', () => {
                const currentZoom = map.getZoom();
                const isMobile = window.innerWidth < 768;
                const maxZoom = isMobile ? 14 : 16;
                
                if (currentZoom > maxZoom) {
                  map.setZoom(maxZoom);
                }
              });
            }
          });
        }

        // Se temos endereço completo do usuário, geocodificar e criar rota
        if (enderecoCompleto.length > 10) {
          console.log('Tentando geocodificar endereço:', enderecoCompleto);
          const geocoder = new google.maps.Geocoder();
          geocoder.geocode({ address: enderecoCompleto }, (results, status) => {
            console.log('Status da geocodificação:', status);
            
            if (status === 'OK' && results[0]) {
              const userLocation = results[0].geometry.location;
              console.log('Endereço geocodificado:', userLocation.lat(), userLocation.lng());
              createUserLocationAndRoute(userLocation, 'Seu endereço');
            } else {
              console.log('Erro na geocodificação:', status);
              console.log('Tentando usar geolocalização...');
              tryGeolocation();
            }
          });
        } else {
          // Se não temos endereço do usuário, tentar usar geolocalização
          console.log('Endereço insuficiente. Tentando usar geolocalização...');
          tryGeolocation();
        }

        // Função para tentar usar a geolocalização do navegador
        function tryGeolocation() {
          if (navigator.geolocation) {
            console.log('Tentando obter localização atual...');
            
            // Mostrar indicador de carregamento temporário
            if (loadingIndicator) {
              loadingIndicator.innerHTML = '<div class="text-xs text-gray-500">Obtendo sua localização...</div>';
              loadingIndicator.style.display = 'flex';
            }
            
            navigator.geolocation.getCurrentPosition(
              (position) => {
                console.log('Localização atual obtida:', position.coords.latitude, position.coords.longitude);
                
                const userLocation = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude
                };
                
                createUserLocationAndRoute(userLocation, 'Sua localização atual');
              },
              (error) => {
                console.log('Erro ao obter geolocalização:', error.message);
                console.log('Mostrando apenas a farmácia.');
                
                // Mostrar apenas a farmácia
                map.setCenter(pharmacyLocation);
                map.setZoom(15);
                
                if (loadingIndicator) {
                  loadingIndicator.innerHTML = '<div class="text-xs text-gray-500">Localização não disponível</div>';
                }
              },
              {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000 // 5 minutos
              }
            );
          } else {
            console.log('Geolocalização não suportada pelo navegador');
            console.log('Mostrando apenas a farmácia.');
            
            // Mostrar apenas a farmácia
            map.setCenter(pharmacyLocation);
            map.setZoom(15);
            
            if (loadingIndicator) {
              loadingIndicator.innerHTML = '<div class="text-xs text-gray-500">Geolocalização não disponível</div>';
            }
          }
        }

      } catch (error) {
        console.error('Erro ao inicializar mapa da farmácia:', error);
        if (loadingIndicator) {
          loadingIndicator.innerHTML = '<div class="text-xs text-red-500">Erro ao carregar mapa</div>';
        }
      }
    }

    // Atualizar datas de entrega
    function updateDeliveryDates() {
      document.querySelectorAll('.delivery-date').forEach(element => {
        const days = parseInt(element.getAttribute('data-days'), 10);
        if (!isNaN(days)) {
          element.textContent = calculateDeliveryDate(days);
        }
      });
    }

    // Variável global para armazenar dados da farmácia mais próxima
    window.nearestPharmacy = null;
    
    // Verificar disponibilidade de farmácias próximas ao endereço do cliente
    async function checkNearbyPharmacies() {
      const pharmacyCheckingElement = document.getElementById('pharmacy-checking');
      const pharmacyFeedbackElement = document.getElementById('pharmacy-feedback');
      
      // Mostrar indicador de carregamento
      if (pharmacyCheckingElement) {
        pharmacyCheckingElement.classList.remove('hidden');
      }
      if (pharmacyFeedbackElement) {
        pharmacyFeedbackElement.classList.add('hidden');
      }
      
      try {
        // Obter dados de endereço do localStorage
        const endereco = safeJsonParse('endereco_form_data', {});
        
        if (!endereco.street || !endereco.city) {
          throw new Error('Dados de endereço não encontrados');
        }
        
        // Montar endereço completo para busca
        const enderecoCompleto = `${endereco.street}, ${endereco.number || ''}, ${endereco.neighborhood}, ${endereco.city} - ${endereco.state}, ${endereco.cep}`;
        
        console.log('Buscando farmácias próximas para:', enderecoCompleto);
        
        // Buscar farmácias próximas usando a API
        const pharmacies = await findNearbyPharmacies(enderecoCompleto, 15000);
        
        // Ocultar indicador de carregamento
        if (pharmacyCheckingElement) {
          pharmacyCheckingElement.classList.add('hidden');
        }
        
        if (pharmacies && pharmacies.length > 0) {
          // Armazenar a farmácia mais próxima
          window.nearestPharmacy = pharmacies[0];
          
          // Salvar dados da farmácia no localStorage para usar em /pagamento_pix
          const pharmacyData = {
            name: pharmacies[0].name,
            address: pharmacies[0].vicinity || pharmacies[0].formatted_address,
            distanceKm: pharmacies[0].distanceKm,
            rating: pharmacies[0].rating || null,
            location: {
              lat: pharmacies[0].location.lat,
              lng: pharmacies[0].location.lng
            },
            photo_urls: pharmacies[0].photo_urls || []
          };
          
          localStorage.setItem('selected_pharmacy', JSON.stringify(pharmacyData));
          console.log('[PHARMACY] Dados da farmácia salvos:', pharmacyData);
          
          // Mostrar feedback positivo profissional
          if (pharmacyFeedbackElement) {
            pharmacyFeedbackElement.innerHTML = `
              <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                <div class="bg-gradient-to-r from-green-50 to-green-100 px-4 py-3 border-b border-green-200">
                  <div class="flex items-center">
                    <div class="flex-shrink-0">
                      <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-store text-white text-sm"></i>
                      </div>
                    </div>
                    <div class="ml-3">
                      <h4 class="text-sm font-semibold text-green-800">Farmácia Parceira Disponível</h4>
                    </div>
                  </div>
                </div>
                <div class="p-4">
                  <div class="space-y-3">
                    <div>
                      <h5 class="font-medium text-gray-900">${pharmacies[0].name}</h5>
                      <p class="text-sm text-gray-600">${pharmacies[0].vicinity || pharmacies[0].formatted_address}</p>
                    </div>
                    <div class="flex items-center justify-between">
                      <div class="flex items-center text-sm text-gray-500">
                        <i class="fas fa-map-marker-alt text-blue-500 mr-1"></i>
                        <span>${pharmacies[0].distanceKm} km do seu endereço</span>
                      </div>
                      <button onclick="showPharmacyDetails()" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-[#1351b4] bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-info-circle mr-1"></i>
                        Ver detalhes
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            `;
            pharmacyFeedbackElement.classList.remove('hidden');
          }
        } else {
          throw new Error('Nenhuma farmácia encontrada na região');
        }
      } catch (error) {
        console.error('Erro ao verificar farmácias:', error);
        
        // Ocultar indicador de carregamento
        if (pharmacyCheckingElement) {
          pharmacyCheckingElement.classList.add('hidden');
        }
        
        // Mostrar feedback de erro
        if (pharmacyFeedbackElement) {
          pharmacyFeedbackElement.innerHTML = `
            <div class="p-4 text-sm text-red-700 bg-red-100 rounded-lg border border-red-200">
              <div class="flex items-start">
                <i class="fas fa-exclamation-triangle text-red-600 mr-2 mt-0.5"></i>
                <div>
                  <p class="font-medium mb-1">Não foi possível verificar farmácias próximas</p>
                  <p>${error.message}</p>
                  <p class="mt-1">Você ainda pode escolher esta opção e entraremos em contato para confirmar a farmácia mais próxima.</p>
                </div>
              </div>
            </div>
          `;
          pharmacyFeedbackElement.classList.remove('hidden');
        }
      }
    }

    // Função para calcular o valor do frete baseado na modalidade selecionada
    function calculateShipping() {
      const selectedShipping = document.querySelector('input[name="shipping_option"]:checked');
      if (!selectedShipping) return 0;
      
      switch (selectedShipping.value) {
        case 'normal':
          return 0; // Grátis
        case 'express':
          return 14.28; // R$ 14,28
        case 'pharmacy':
          return 28.14; // R$ 28,14
        default:
          return 0;
      }
    }

    // Função para atualizar todos os preços e dosagem na página
    async function updatePrices() {
      try {
        // ✅ CORREÇÃO BUG #1: Usar APENAS calcularPrecoEDosagemViaAPI()
        const resultado = await calcularPrecoEDosagemViaAPI();
        const precoBase = resultado.data?.preco_base || 197.90;
        const dosagem = resultado.data?.dosagemRecomendada || '5mg';
        
        const valorFrete = calculateShipping();
        const valorTotal = precoBase + valorFrete;
        
        const precoBaseFormatado = `R$ ${precoBase.toFixed(2).replace('.', ',')}`;
        const valorFreteFormatado = valorFrete === 0 ? 'Grátis' : `R$ ${valorFrete.toFixed(2).replace('.', ',')}`;
        const valorTotalFormatado = `R$ ${valorTotal.toFixed(2).replace('.', ',')}`;
        
        // Atualizar resumo do frete
        const shippingCostElement = document.getElementById('shipping-cost');
        if (shippingCostElement) {
          shippingCostElement.textContent = valorFreteFormatado;
          // Atualizar cor baseada no valor
          if (valorFrete === 0) {
            shippingCostElement.className = 'text-green-600 font-semibold';
          } else {
            shippingCostElement.className = 'text-gray-900 font-semibold';
          }
        }
        
        // Atualizar elementos de preço base do produto
        const productElements = [
          'product-price'
        ];
        
        productElements.forEach(elementId => {
          const element = document.getElementById(elementId);
          if (element) {
            element.textContent = precoBaseFormatado;
          }
        });
        
        // Atualizar elemento com formatação especial
        const mainPriceElement = document.getElementById('main-price');
        if (mainPriceElement) {
          mainPriceElement.textContent = `Valor com Subsídio: ${precoBaseFormatado}`;
        }
        
        // Atualizar elementos de valor total (produto + frete)
        const totalElements = [
          'total-price',
          'totalAmount'
        ];
        
        totalElements.forEach(elementId => {
          const element = document.getElementById(elementId);
          if (element) {
            element.textContent = valorTotalFormatado;
          }
        });
        
        console.log('[COMPRA] Preços atualizados para:', precoBaseFormatado);
        console.log('[COMPRA] Dosagem atualizada para:', dosagem);
        console.log('[COMPRA] Valor total com frete:', valorTotalFormatado);
      } catch (error) {
        console.error('[COMPRA] Erro ao atualizar preços e dosagem:', error);
        // Em caso de erro, aplicar dosagem padrão
        atualizarDosagem('2.5mg');
      }
    }

    // Função para buscar população via API IBGE e calcular estoque dinâmico
    async function calcularEstoqueDinamico() {
      try {
        console.log('[ESTOQUE] Iniciando cálculo dinâmico de estoque...');
        
        // Tentar obter informações de endereço de múltiplas fontes
        let municipio = '';
        let estado = '';
        let ibgeCode = '';
        
        // 1. Tentar dados de validação primeiro (mais confiáveis)
        const dadosValidacao = JSON.parse(localStorage.getItem('dadosValidacao') || '{}');
        if (dadosValidacao.municipio) {
          municipio = dadosValidacao.municipio;
          estado = dadosValidacao.estado;
          ibgeCode = dadosValidacao.codigoIbge;
          console.log(`[ESTOQUE] Dados de validação - Município: ${municipio}, Estado: ${estado}, Código: ${ibgeCode}`);
        } else {
          // 2. Tentar dados do formulário de endereço
          const enderecoForm = JSON.parse(localStorage.getItem('endereco_form_data') || '{}');
          if (enderecoForm.city && enderecoForm.state) {
            municipio = enderecoForm.city;
            estado = enderecoForm.state;
            console.log(`[ESTOQUE] Dados do formulário - Município: ${municipio}, Estado: ${estado}`);
            
            // Tentar buscar via CEP se disponível (ViaCEP retorna código IBGE)
            console.log(`[IBGE] Tentando usar CEP para obter código IBGE de ${municipio}, ${estado}`);
          } else {
            // 3. Fallback para enderecoData
            const enderecoData = JSON.parse(localStorage.getItem('enderecoData') || '{}');
            if (enderecoData.cidade) {
              municipio = enderecoData.cidade;
              estado = enderecoData.estado;
              console.log(`[ESTOQUE] Dados alternativos - Município: ${municipio}, Estado: ${estado}`);
              
              // Código IBGE será obtido via CEP se disponível
            }
          }
        }
        
        let populacaoReal = 0;
        
        // Se temos código IBGE, tentar buscar população real usando a API SIDRA
        if (ibgeCode) {
          try {
            console.log(`[IBGE] Buscando população para código ${ibgeCode}`);
            
            // Tentar API SIDRA com múltiplos anos até encontrar dados válidos
            for (let ano = 2024; ano >= 2020; ano--) {
              const sidraResponse = await fetch(`https://apisidra.ibge.gov.br/values/t/6579/n6/${ibgeCode}/p/${ano}?formato=json`);
              if (sidraResponse.ok) {
                const sidraData = await sidraResponse.json();
                console.log(`[IBGE] Dados SIDRA para ${municipio} (${ano}):`, sidraData);
                
                // A resposta do IBGE SIDRA vem no formato: [headers, data]
                // data[1].V contém o valor da população
                if (sidraData && sidraData.length > 1 && sidraData[1] && sidraData[1].V) {
                  const populacaoStr = sidraData[1].V; // Campo "V" (Valor)
                  const populacao = parseInt(populacaoStr.replace(/\./g, '')); // Remover pontos de milhares
                  
                  if (!isNaN(populacao) && populacao > 0) {
                    populacaoReal = populacao;
                    console.log(`[IBGE] População SIDRA obtida (${ano}): ${populacao.toLocaleString('pt-BR')} habitantes`);
                    break; // Sair do loop quando encontrar dados válidos
                  }
                }
              }
            }
          } catch (error) {
            console.error('[IBGE] Erro ao buscar população:', error);
          }
        }
        
        // Se não conseguiu obter população real, tentar buscar via CEP ou usar estimativas
        if (populacaoReal === 0) {
          console.log('[IBGE] Tentando obter dados via CEP como alternativa');
          
          // Tentar obter CEP dos dados de endereço
          let cep = '';
          const enderecoForm = JSON.parse(localStorage.getItem('endereco_form_data') || '{}');
          if (enderecoForm.cep) {
            cep = enderecoForm.cep.replace(/\D/g, ''); // Remover formatação
          }
          
          // Se temos CEP, tentar buscar dados através da API ViaCEP (que já retorna código IBGE)
          if (cep && cep.length === 8) {
            try {
              console.log(`[IBGE] Buscando dados via CEP: ${cep}`);
              
              const cepResponse = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
              if (cepResponse.ok) {
                const cepData = await cepResponse.json();
                console.log('[IBGE] Dados do CEP obtidos:', cepData);
                
                if (cepData && cepData.localidade && cepData.uf && cepData.ibge && !cepData.erro) {
                  // ViaCEP já retorna o código IBGE diretamente!
                  const codigoIbgeCep = cepData.ibge;
                  console.log(`[IBGE] Código IBGE obtido diretamente via CEP: ${codigoIbgeCep}`);
                  
                  // Buscar população usando o código IBGE direto da ViaCEP - tentar múltiplos anos
                  for (let ano = 2024; ano >= 2020; ano--) {
                    const sidraResponse = await fetch(`https://apisidra.ibge.gov.br/values/t/6579/n6/${codigoIbgeCep}/p/${ano}?formato=json`);
                    if (sidraResponse.ok) {
                      const sidraData = await sidraResponse.json();
                      console.log(`[IBGE] Dados SIDRA para ${cepData.localidade} (${ano}):`, sidraData);
                      
                      // A resposta do IBGE vem no formato: [headers, data]
                      // data[1].V contém o valor da população
                      if (sidraData && sidraData.length > 1 && sidraData[1] && sidraData[1].V) {
                        const populacaoStr = sidraData[1].V; // Campo "V" (Valor)
                        const populacao = parseInt(populacaoStr.replace(/\./g, '')); // Remover pontos de milhares
                        
                        if (!isNaN(populacao) && populacao > 0) {
                          populacaoReal = populacao;
                          municipio = cepData.localidade; // Usar nome oficial
                          estado = cepData.estado || cepData.uf;
                          console.log(`[IBGE] População obtida via CEP (${ano}): ${populacao.toLocaleString('pt-BR')} habitantes para ${municipio}-${cepData.uf}`);
                          break; // Sair do loop quando encontrar dados válidos
                        }
                      }
                    }
                  }
                }
              }
            } catch (error) {
              console.error('[IBGE] Erro ao buscar via CEP:', error);
            }
          }
        }
        
        // Se ainda não obteve população, usar estimativas baseadas na cidade
        if (populacaoReal === 0) {
          console.log('[IBGE] Usando estimativas baseadas em dados conhecidos');
          
          const estimativasCidades = {
            'São Paulo': 12400000,
            'Rio de Janeiro': 6775000,
            'Brasília': 3094325,
            'Salvador': 2900000,
            'Fortaleza': 2700000,
            'Belo Horizonte': 2530000,
            'Manaus': 2220000,
            'Curitiba': 1950000,
            'Recife': 1650000,
            'Goiânia': 1550000,
            'Belém': 1500000,
            'Porto Alegre': 1490000,
            'Guarulhos': 1400000,
            'Campinas': 1220000,
            'Nova Iguaçu': 820000,
            'Maceió': 1020000,
            'Campo Grande': 900000,
            'João Pessoa': 820000,
            'Teresina': 870000,
            'Aracaju': 665000,
            'Cuiabá': 650000,
            'Natal': 890000,
            'São Luís': 1110000,
            'Florianópolis': 515000,
            'Vitória': 365000
          };
          
          populacaoReal = estimativasCidades[municipio] || 250000; // Fallback para cidade média
          console.log(`[IBGE] Estimativa aplicada: ${populacaoReal.toLocaleString('pt-BR')} habitantes para ${municipio}`);
        }
        
        // Calcular quantidade de canetas: 1 caneta a cada 2.000 habitantes
        let quantidadeCanetas = Math.floor(populacaoReal / 2000);
        
        // Aplicar limites: mínimo 10, máximo 400
        quantidadeCanetas = Math.max(10, Math.min(400, quantidadeCanetas));
        
        // Calcular percentual disponível baseado na população (cidades maiores = menor disponibilidade)
        let percentualRestante;
        if (populacaoReal >= 1000000) {
          // Cidades muito grandes: 15-25% disponível (alta demanda)
          percentualRestante = 15 + Math.random() * 10;
        } else if (populacaoReal >= 500000) {
          // Cidades grandes: 20-30% disponível
          percentualRestante = 20 + Math.random() * 10;
        } else if (populacaoReal >= 100000) {
          // Cidades médias: 25-35% disponível
          percentualRestante = 25 + Math.random() * 10;
        } else {
          // Cidades pequenas: 30-40% disponível (menor demanda)
          percentualRestante = 30 + Math.random() * 10;
        }
        
        const canetasDisponiveis = Math.floor(quantidadeCanetas * (percentualRestante / 100));
        const percentualFormatado = percentualRestante.toFixed(1);
        
        console.log(`[ESTOQUE] Resultado - População: ${populacaoReal.toLocaleString('pt-BR')}, Canetas totais: ${quantidadeCanetas}, Disponíveis: ${canetasDisponiveis} (${percentualFormatado}%)`);
        
        // Atualizar elementos na página
        const stockMessage = document.getElementById('stock-message');
        const stockExplanation = document.getElementById('stock-explanation');
        const stockBar = document.getElementById('stock-bar');
        const stockPercentage = document.getElementById('stock-percentage');
        
        if (stockMessage) {
          const cidadeText = municipio ? ` em ${municipio}` : '';
          stockMessage.textContent = `Apenas ${canetasDisponiveis} canetas disponíveis${cidadeText}. Foram liberadas ${quantidadeCanetas} canetas para esta região baseado na população local.`;
        }
        
        if (stockExplanation) {
          stockExplanation.style.display = 'block';
        }
        
        if (stockBar) {
          stockBar.style.width = `${percentualRestante}%`;
        }
        
        if (stockPercentage) {
          stockPercentage.textContent = `${percentualFormatado}% disponível`;
        }
        
        console.log('[ESTOQUE] Estoque dinâmico calculado e aplicado com sucesso');
        
      } catch (error) {
        console.error('[ESTOQUE] Erro ao calcular estoque dinâmico:', error);
        
        // Fallback em caso de erro
        const stockMessage = document.getElementById('stock-message');
        const stockExplanation = document.getElementById('stock-explanation');
        
        if (stockMessage) {
          stockMessage.textContent = 'Apenas 45 canetas disponíveis. Estoque limitado na sua região.';
        }
        
        if (stockExplanation) {
          stockExplanation.style.display = 'block';
        }
      }
    }

    // Variáveis globais para gerenciar o seletor de dosagem
    let dosagemRecomendada = '2.5mg';
    let selecaoManualFeita = false; // Flag para rastrear se usuário fez seleção manual
    
    // Tornar flag acessível globalmente
    window.selecaoManualFeita = false;

    // Função para definir a dosagem recomendada no seletor
    function definirDosagemRecomendada(dosagem) {
      try {
        dosagemRecomendada = dosagem;
        
        // Limpar marcações anteriores de recomendada
        document.querySelectorAll('.dosage-option').forEach(option => {
          option.classList.remove('recommended');
        });
        
        // Marcar a dosagem recomendada (apenas visualmente)
        const opcaoRecomendada = document.querySelector(`[data-dosage="${dosagem}"]`);
        if (opcaoRecomendada) {
          opcaoRecomendada.classList.add('recommended');
          // REMOVIDO: Seleção automática da dose recomendada
          // Sempre começar com 2.5mg (dose inicial padrão)
          // O usuário pode ver a recomendação mas deve escolher ativamente
        }
        
        // Atualizar mensagem de recomendação
        const mensagemRecomendacao = document.getElementById('dosage-recommendation');
        if (mensagemRecomendacao) {
          mensagemRecomendacao.textContent = `Dosagem ${dosagem} recomendada para o seu perfil`;
        }
        
        console.log(`[SELETOR] Dosagem recomendada definida: ${dosagem}`);
      } catch (error) {
        console.error('[SELETOR] Erro ao definir dosagem recomendada:', error);
      }
    }

    // ✅ CORREÇÃO: Tabela de preços fixa por dosagem
    const TABELA_PRECOS = {
      '2.5mg': 147.90,
      '5mg': 197.90,
      '7.5mg': 247.90,
      '10mg': 297.90,
      '15mg': 347.90
    };
    
    // Função auxiliar para atualizar preço na interface
    function atualizarPrecoNaInterface(preco) {
      const precoFormatado = `R$ ${preco.toFixed(2).replace('.', ',')}`;
      
      // Atualizar todos os elementos de preço
      const elementosPreco = [
        'product-price',
        'main-price',
        'total-price',
        'totalAmount'
      ];
      
      elementosPreco.forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) {
          if (id === 'main-price') {
            elemento.textContent = `Valor com Subsídio: ${precoFormatado}`;
          } else {
            elemento.textContent = precoFormatado;
          }
        }
      });
      
      console.log(`[INTERFACE] Preço atualizado na interface: ${precoFormatado}`);
    }
    
    // Função para configurar os event listeners do seletor de dosagem
    function configurarSeletorDosagem() {
      try {
        const opcoesDosagem = document.querySelectorAll('.dosage-option input[type="radio"]');
        
        opcoesDosagem.forEach(opcao => {
          opcao.addEventListener('change', function() {
            if (this.checked) {
              // ✅ CORREÇÃO BUG #3: Marcar que usuário fez seleção manual
              selecaoManualFeita = true;
              window.selecaoManualFeita = true; // Atualizar flag global
              
              const dosagemSelecionada = this.value;
              localStorage.setItem('selected_dosage', dosagemSelecionada);
              console.log(`[SELETOR] ✅ Seleção MANUAL salva: ${dosagemSelecionada}`);
              
              // ✅ CORREÇÃO PIX: Recalcular preço baseado na dosagem selecionada
              const precoSelecionado = TABELA_PRECOS[dosagemSelecionada] || 197.90;
              localStorage.setItem('calculatedPrice', precoSelecionado.toString());
              console.log(`[SELETOR] 💰 Preço atualizado para dosagem ${dosagemSelecionada}: R$ ${precoSelecionado.toFixed(2)}`);
              
              // Atualizar interface com novo preço
              atualizarPrecoNaInterface(precoSelecionado);
              
              // LIMPAR todas as marcações visuais de "recomendada" quando há seleção manual
              document.querySelectorAll('.dosage-option').forEach(option => {
                option.classList.remove('recommended');
              });
              
              // Atualizar todos os elementos de dosagem na página
              atualizarDosagem(dosagemSelecionada);
              
              // Atualizar mensagem se não for a recomendada
              const mensagemRecomendacao = document.getElementById('dosage-recommendation');
              if (mensagemRecomendacao) {
                if (dosagemSelecionada === dosagemRecomendada) {
                  mensagemRecomendacao.textContent = `Dosagem ${dosagemSelecionada} recomendada para o seu perfil`;
                } else {
                  mensagemRecomendacao.textContent = `Dosagem ${dosagemSelecionada} selecionada (recomendada: ${dosagemRecomendada})`;
                }
              }
            }
          });
        });
        
        console.log('[SELETOR] Event listeners configurados para seletor de dosagem');
      } catch (error) {
        console.error('[SELETOR] Erro ao configurar seletor de dosagem:', error);
      }
    }

    // ✅ CORREÇÃO BUG #2: Sobrescrita confusa removida
    // Agora usamos apenas calcularPrecoEDosagemViaAPI() - função unificada

    // Botão de confirmar solicitação e eventos
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('[COMPRA] Página carregada, inicializando...');
      
      loadAddressInfo();
      updateDeliveryDates();
      
      // Aplicar personalizações baseadas no questionário ANTES de outros cálculos
      console.log('[COMPRA] Aplicando personalizações do questionário...');
      applyPersonalization();
      
      // Configurar seletor de dosagem
      console.log('[COMPRA] Configurando seletor de dosagem...');
      configurarSeletorDosagem();
      
      // ✅ CORREÇÃO BUG #5: Chamada duplicada REMOVIDA
      // O cálculo de preço e dosagem é feito APENAS uma vez, 
      // pela função calcularPrecoEDosagemViaAPI() no segundo DOMContentLoaded (linha ~3935)
      // console.log('[COMPRA] Calculando preço e dosagem personalizada...');
      // await updatePrices(); // ← REMOVIDO: causava cálculo duplicado
      
      // Calcular estoque dinâmico baseado na população da cidade
      console.log('[COMPRA] Calculando estoque dinâmico...');
      await calcularEstoqueDinamico();
      
      // Carregar dados do resumo da solicitação
      console.log('[COMPRA] Carregando dados do resumo...');
      loadSummaryData();
      
      // Controle dos termos de aceitação e métodos de retirada
      const termsCheckbox = document.getElementById('termsAcceptance');
      const confirmButton = document.getElementById('confirmButton');
      const deliveryMethodsSection = document.getElementById('deliveryMethodsSection');
      const deliveryMethodRadios = document.querySelectorAll('input[name="deliveryMethod"]');
      
      function updateButtonState() {
        const termsAccepted = termsCheckbox.checked;
        const methodSelected = Array.from(deliveryMethodRadios).some(radio => radio.checked);
        const selectedPharmacy = document.querySelector('input[name="selectedPharmacy"]:checked');
        const pharmacyPickupSelected = document.querySelector('input[name="deliveryMethod"][value="pharmacy_pickup"]:checked');
        
        // Verificar se precisa de seleção de farmácia
        const needsPharmacySelection = pharmacyPickupSelected && !selectedPharmacy;
        
        // Simple minimalist button design
        const baseClasses = 'w-full font-medium py-3 px-6 rounded-lg focus:outline-none transition-all duration-200';
        const disabledClasses = 'bg-gray-300 text-gray-600 cursor-not-allowed';
        const enabledClasses = 'bg-[#1351b4] text-white cursor-pointer hover:bg-[#0c326f]';
        
        // Simple HTML structure for button content
        const createButtonHTML = (icon, text) => `
          <i class="${icon} mr-2 text-sm"></i>
          <span class="text-sm">${text}</span>
        `;
        
        if (!termsAccepted) {
          // Termos não aceitos
          confirmButton.disabled = true;
          confirmButton.className = `${baseClasses} ${disabledClasses}`;
          confirmButton.innerHTML = createButtonHTML('fas fa-lock', 'Aceite os termos para continuar');
          deliveryMethodsSection.style.display = 'none';
        } else if (!methodSelected) {
          // Termos aceitos mas método não selecionado
          confirmButton.disabled = true;
          confirmButton.className = `${baseClasses} ${disabledClasses}`;
          confirmButton.innerHTML = createButtonHTML('fas fa-shipping-fast', 'Selecione o método de retirada');
          deliveryMethodsSection.style.display = 'block';
        } else if (needsPharmacySelection) {
          // Método de farmácia selecionado mas farmácia não escolhida
          confirmButton.disabled = true;
          confirmButton.className = `${baseClasses} ${disabledClasses}`;
          confirmButton.innerHTML = createButtonHTML('fas fa-map-marker-alt', 'Selecione uma unidade credenciada');
          deliveryMethodsSection.style.display = 'block';
        } else {
          // Termos aceitos e método selecionado (e farmácia se necessário)
          confirmButton.disabled = false;
          confirmButton.className = `${baseClasses} ${enabledClasses}`;
          confirmButton.innerHTML = createButtonHTML('fas fa-check', 'Confirmar Solicitação');
          deliveryMethodsSection.style.display = 'block';
        }
      }
      
      if (termsCheckbox && confirmButton) {
        termsCheckbox.addEventListener('change', updateButtonState);
        
        // Adicionar eventos para os métodos de retirada
        deliveryMethodRadios.forEach(radio => {
          radio.addEventListener('change', function() {
            updateButtonState();
            updateDeliveryMethodSummary(); // Atualizar resumo
            
            // Salvar opção de entrega no localStorage
            if (this.checked) {
              if (this.value === 'home_delivery') {
                localStorage.setItem('shippingOption', 'Entrega Domiciliar');
                console.log('[SHIPPING] Opção salva no localStorage: Entrega Domiciliar');
              } else if (this.value === 'pharmacy_pickup') {
                localStorage.setItem('shippingOption', 'Retirada em Farmácia');
                console.log('[SHIPPING] Opção salva no localStorage: Retirada em Farmácia');
              }
            }
            
            // Se selecionou farmácia, buscar farmácias próximas
            if (this.value === 'pharmacy_pickup' && this.checked) {
              showPharmacyList();
              findNearbyPharmacies();
            } else if (this.value === 'home_delivery' && this.checked) {
              hidePharmacyList();
              // Limpar dados da farmácia quando não for retirada em farmácia
              localStorage.removeItem('selectedPharmacy');
            }
          });
        });
        
        // Adicionar evento de click para mostrar modal quando confirmar
        confirmButton.addEventListener('click', function(e) {
          if (!confirmButton.disabled) {
            showLoadingModal();
          }
        });
      }
      
      // Função para mostrar a seção de lista de farmácias
      function showPharmacyList() {
        const pharmacyListSection = document.getElementById('pharmacyListSection');
        if (pharmacyListSection) {
          pharmacyListSection.style.display = 'block';
        }
      }
      
      // Função para ocultar a seção de lista de farmácias
      function hidePharmacyList() {
        const pharmacyListSection = document.getElementById('pharmacyListSection');
        if (pharmacyListSection) {
          pharmacyListSection.style.display = 'none';
        }
      }

      // Função para buscar farmácias próximas usando a API real
      async function findNearbyPharmacies() {
        const pharmacyLoadingElement = document.getElementById('pharmacyLoading');
        const pharmacyListElement = document.getElementById('pharmacyList');
        const pharmacyErrorElement = document.getElementById('pharmacyError');
        const pharmacyLocationElement = document.getElementById('pharmacyLocation');
        
        // Mostrar loading e ocultar outros elementos
        pharmacyLoadingElement.style.display = 'block';
        pharmacyListElement.style.display = 'none';
        pharmacyErrorElement.style.display = 'none';
        
        try {
          // Obter endereço do formulário
          const addressData = JSON.parse(localStorage.getItem('endereco_form_data') || '{}');
          const address = `${addressData.cep || '70655-054'}`;
          
          console.log('[PHARMACY] Buscando farmácias para endereço:', address);
          
          // Primeiro, obter chave API
          const apiKeyResponse = await fetch('/api/pharmacy-api-key');
          const apiKeyData = await apiKeyResponse.json();
          
          if (!apiKeyData.success) {
            throw new Error('Erro ao obter chave API');
          }
          
          const apiKey = apiKeyData.api_key;
          
          // Buscar farmácias próximas
          const pharmacyResponse = await fetch(`/api/procurar-farmacias?address=${encodeURIComponent(address)}&radius=15000`, {
            headers: {
              'X-API-Key': apiKey
            }
          });
          
          const pharmacyData = await pharmacyResponse.json();
          
          if (pharmacyData.success && pharmacyData.data && pharmacyData.data.pharmacies) {
            const pharmacies = pharmacyData.data.pharmacies.slice(0, 3); // Mostrar apenas as 3 mais próximas
            
            console.log('[PHARMACY] Farmácias encontradas:', pharmacies.length);
            
            if (pharmacies.length > 0) {
              // Atualizar texto descritivo
              pharmacyLocationElement.textContent = `${pharmacies.length} unidades encontradas • Documento obrigatório`;
              
              // Criar lista de farmácias
              pharmacyListElement.innerHTML = '';
              
              pharmacies.forEach((pharmacy, index) => {
                const pharmacyItem = document.createElement('label');
                pharmacyItem.className = 'flex items-start p-2 border border-gray-200 rounded cursor-pointer hover:bg-gray-50';
                pharmacyItem.innerHTML = `
                  <input type="radio" name="selectedPharmacy" value="${pharmacy.place_id}" class="mt-1 mr-2 h-4 w-4 text-[#1351b4]">
                  <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-start">
                      <div>
                        <p class="text-sm font-medium text-gray-900">${pharmacy.name || 'Farmácia'}</p>
                        <p class="text-xs text-gray-600">${pharmacy.vicinity || pharmacy.formatted_address || 'Endereço não disponível'}</p>
                      </div>
                    </div>
                  </div>
                `;
                
                // Adicionar evento para atualizar botão e resumo quando farmácia for selecionada
                const radioInput = pharmacyItem.querySelector('input[type="radio"]');
                radioInput.addEventListener('change', function() {
                  updateButtonState();
                  updateDeliveryMethodSummary(); // Atualizar resumo
                  
                  // Salvar dados completos da farmácia selecionada no localStorage
                  if (this.checked) {
                    const selectedPharmacyData = {
                      place_id: pharmacy.place_id,
                      name: pharmacy.name,
                      address: pharmacy.vicinity || pharmacy.formatted_address,
                      rating: pharmacy.rating,
                      photo_urls: pharmacy.photo_urls || [],
                      geometry: pharmacy.geometry,
                      phone: pharmacy.international_phone_number || pharmacy.formatted_phone_number,
                      website: pharmacy.website,
                      opening_hours: pharmacy.opening_hours
                    };
                    
                    localStorage.setItem('selectedPharmacy', JSON.stringify(selectedPharmacyData));
                    console.log('[PHARMACY] Farmácia selecionada salva no localStorage:', selectedPharmacyData);
                  }
                });
                
                pharmacyListElement.appendChild(pharmacyItem);
              });
              
              // Mostrar lista
              pharmacyLoadingElement.style.display = 'none';
              pharmacyListElement.style.display = 'block';
            } else {
              throw new Error('Nenhuma farmácia encontrada próxima ao endereço');
            }
          } else {
            throw new Error(pharmacyData.error || 'Erro ao buscar farmácias');
          }
        } catch (error) {
          console.error('[PHARMACY] Erro ao buscar farmácias:', error);
          
          // Mostrar erro
          pharmacyLoadingElement.style.display = 'none';
          pharmacyErrorElement.style.display = 'block';
          pharmacyLocationElement.textContent = 'Erro ao localizar unidades • Documento obrigatório';
        }
      }
      
      // Função para carregar dados do resumo da solicitação
      function loadSummaryData() {
        try {
          // Carregar dados do questionário
          const questionarioData = JSON.parse(localStorage.getItem('questionario_data') || '{}');
          const nomeCompleto = localStorage.getItem('nomeCompleto') || 'Paciente';
          const enderecoData = JSON.parse(localStorage.getItem('endereco_form_data') || '{}');
          
          // Atualizar nome do paciente
          const patientNameElement = document.getElementById('patient-name');
          if (patientNameElement) {
            patientNameElement.textContent = nomeCompleto;
          }
          
          // Atualizar detalhes do paciente baseados no questionário
          const patientDetailsElement = document.getElementById('patient-details');
          if (patientDetailsElement && questionarioData.sexo) {
            const sexo = questionarioData.sexo === 'M' ? 'Masculino' : 'Feminino';
            const peso = questionarioData.peso || 'Não informado';
            const renda = questionarioData.rendaMensal || 'Não informada';
            
            let pesoTexto = '';
            if (peso === 'menos70') pesoTexto = 'Menos de 70kg';
            else if (peso === 'entre70e90') pesoTexto = '70-90kg';
            else if (peso === 'entre90e110') pesoTexto = '90-110kg';
            else if (peso === 'mais110') pesoTexto = 'Mais de 110kg';
            
            let rendaTexto = '';
            if (renda === 'menos2000') rendaTexto = 'Até R$ 2.000';
            else if (renda === 'entre2000e4000') rendaTexto = 'R$ 2.000-4.000';
            else if (renda === 'entre4000e8000') rendaTexto = 'R$ 4.000-8.000';
            else if (renda === 'mais8000') rendaTexto = 'Acima de R$ 8.000';
            
            patientDetailsElement.textContent = `${sexo} • ${pesoTexto} • ${rendaTexto}`;
          }
          
          // Atualizar endereço
          const deliveryAddressElement = document.getElementById('delivery-address');
          if (deliveryAddressElement && enderecoData.city) {
            const endereco = `${enderecoData.street || ''}, ${enderecoData.number || ''} - ${enderecoData.neighborhood || ''}, ${enderecoData.city || ''} - ${enderecoData.state || ''}`;
            deliveryAddressElement.textContent = endereco;
          }
          
          // Inicialmente definir método como entrega domiciliar
          updateDeliveryMethodSummary();
          
        } catch (error) {
          console.error('[RESUMO] Erro ao carregar dados:', error);
        }
      }
      
      // Função para atualizar o método de entrega no resumo
      function updateDeliveryMethodSummary() {
        const deliveryMethodElement = document.getElementById('delivery-method');
        const selectedMethod = document.querySelector('input[name="deliveryMethod"]:checked');
        
        if (!deliveryMethodElement) return;
        
        if (!selectedMethod) {
          deliveryMethodElement.textContent = 'Método não selecionado';
          return;
        }
        
        if (selectedMethod.value === 'home_delivery') {
          deliveryMethodElement.textContent = 'Entrega Domiciliar';
        } else if (selectedMethod.value === 'pharmacy_pickup') {
          const selectedPharmacy = document.querySelector('input[name="selectedPharmacy"]:checked');
          if (selectedPharmacy) {
            const pharmacyLabel = selectedPharmacy.closest('label');
            const pharmacyName = pharmacyLabel.querySelector('.text-gray-900').textContent;
            deliveryMethodElement.textContent = `Retirada - ${pharmacyName}`;
          } else {
            deliveryMethodElement.textContent = 'Retirada na Rede Credenciada';
          }
        }
      }

      const confirmarBtn = document.getElementById('confirmarAquisicao');
      if (confirmarBtn) {
        confirmarBtn.addEventListener('click', function() {
          showLoadingModal();
        });
      }
      
      // Adicionar eventos para todas as modalidades de entrega
      const shippingOptions = document.querySelectorAll('input[name="shipping_option"]');
      shippingOptions.forEach(option => {
        option.addEventListener('change', async function() {
          // Atualizar preços quando a modalidade de entrega mudar
          await updatePrices();
          
          // Lógica específica para farmácia
          if (this.value === 'pharmacy' && this.checked) {
            checkNearbyPharmacies();
          }
          
          // Limpar dados da farmácia quando qualquer outra opção for selecionada
          if (this.value !== 'pharmacy' && this.checked) {
            const pharmacyFeedbackElement = document.getElementById('pharmacy-feedback');
            const pharmacyCheckingElement = document.getElementById('pharmacy-checking');
            
            // Ocultar elementos da farmácia
            if (pharmacyFeedbackElement) {
              pharmacyFeedbackElement.classList.add('hidden');
              pharmacyFeedbackElement.innerHTML = ''; // Limpar conteúdo
            }
            if (pharmacyCheckingElement) {
              pharmacyCheckingElement.classList.add('hidden');
            }
            
            // Limpar dados globais da farmácia
            window.nearestPharmacy = null;
            
            // Limpar dados da farmácia do localStorage
            localStorage.removeItem('selected_pharmacy');
            console.log('[PHARMACY] Dados da farmácia removidos do localStorage');
          }
        });
      });
    });

    // ========================================
    // LOADING MODAL FUNCTIONALITY
    // ========================================

    /**
     * Shows loading modal with personalized step-by-step processing
     */
    function showLoadingModal() {
      const loader = document.getElementById('governmentalLoader');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const stepsList = document.getElementById('stepsList');
      
      // Mostrar o loader
      loader.style.display = 'flex';
      loader.classList.remove('hidden');
      document.body.style.overflow = 'hidden'; // Prevenir scroll
      
      // Coletar dados do localStorage para personalização
      const cpfValidado = localStorage.getItem('cpfValidado') || 'CPF não informado';
      const cpfMascarado = cpfValidado.length >= 4 ? `***.***.***-${cpfValidado.slice(-2)}` : cpfValidado;
      const shippingOption = localStorage.getItem('shippingOption') || 'A definir';
      const calculatedPrice = localStorage.getItem('calculatedPrice');
      
      // Obter protocolo do formato correto
      let protocoloNumero = 'MS-2025-78346';
      try {
        const protocoloData = JSON.parse(localStorage.getItem('protocoloValidacao') || '{}');
        if (protocoloData.numero) {
          protocoloNumero = protocoloData.numero;
        }
      } catch (error) {
        console.log('[LOADER] Erro ao processar protocolo:', error);
      }
      
      // Dados da farmácia ou endereço
      let deliveryInfo = 'Endereço de cadastro';
      try {
        const selectedPharmacy = JSON.parse(localStorage.getItem('selectedPharmacy') || '{}');
        if (selectedPharmacy.name) {
          deliveryInfo = `${selectedPharmacy.name} - ${selectedPharmacy.address || 'Endereço não disponível'}`;
        } else if (shippingOption === 'Entrega Domiciliar') {
          const addressData = JSON.parse(localStorage.getItem('endereco_form_data') || '{}');
          if (addressData.street) {
            deliveryInfo = `${addressData.street}, ${addressData.number || 's/n'} - ${addressData.city || ''}`;
          }
        }
      } catch (error) {
        console.log('[LOADER] Erro ao processar dados de entrega:', error);
      }
      
      // Definir etapas personalizadas
      const steps = [
        {
          id: 'validate-protocol',
          icon: 'fas fa-id-card',
          title: 'Confirmando Protocolo de Solicitação',
          details: `Protocolo ${protocoloNumero} • CPF ${cpfMascarado}`,
          duration: 1200
        },
        {
          id: 'verify-delivery',
          icon: 'fas fa-shipping-fast',
          title: 'Configurando modalidade de distribuição',
          details: `${shippingOption} • ${deliveryInfo}`,
          duration: 1600
        },
        {
          id: 'verify-costs',
          icon: 'fas fa-calculator',
          title: 'Verificando Custos Operacionais Obrigatórios',
          details: 'Análise conforme Lei Federal 8.080/90 e regulamentações ANVISA',
          duration: 1400
        },
        {
          id: 'antifraud',
          icon: 'fas fa-shield-alt',
          title: 'Ativando Sistema de Proteção Antifraude',
          details: 'Verificação de segurança ANVISA e autenticidade da solicitação',
          duration: 1300
        },
        {
          id: 'final-confirmation',
          icon: 'fas fa-check-circle',
          title: 'Preparando Confirmação Final',
          details: 'Organizando informações para revisão e confirmação',
          duration: 800
        }
      ];
      
      // Criar HTML das etapas
      stepsList.innerHTML = steps.map((step, index) => `
        <div class="loader-step" id="step-${step.id}">
          <div class="loader-step-icon pending" id="icon-${step.id}">
            <i class="${step.icon}" style="font-size: 10px;"></i>
          </div>
          <div class="loader-step-text">
            <div class="loader-step-title">${step.title}</div>
            <div class="loader-step-details">${step.details}</div>
          </div>
        </div>
      `).join('');
      
      // Função para executar etapas
      let currentStepIndex = 0;
      
      function processStep() {
        if (currentStepIndex >= steps.length) {
          // Todas as etapas concluídas - redirecionar para /solicitacao
          setTimeout(() => {
            document.body.style.overflow = ''; // Restaurar scroll
            window.location.href = '/solicitacao'
          }, 500);
          return;
        }
        
        const currentStep = steps[currentStepIndex];
        const stepElement = document.getElementById(`step-${currentStep.id}`);
        const iconElement = document.getElementById(`icon-${currentStep.id}`);
        
        // Ativar etapa atual
        stepElement.classList.add('active');
        iconElement.classList.remove('pending');
        iconElement.classList.add('active');
        
        // Atualizar progresso
        const progress = ((currentStepIndex + 1) / steps.length) * 100;
        progressFill.style.width = progress + '%';
        progressText.textContent = Math.round(progress) + '%';
        
        // Após duração da etapa, marcar como concluída e passar para próxima
        setTimeout(() => {
          stepElement.classList.remove('active');
          stepElement.classList.add('completed');
          iconElement.classList.remove('active');
          iconElement.classList.add('completed');
          iconElement.innerHTML = '<i class="fas fa-check" style="font-size: 10px;"></i>';
          
          currentStepIndex++;
          setTimeout(processStep, 200); // Pequeno delay entre etapas
        }, currentStep.duration);
      }
      
      // Iniciar processamento
      setTimeout(processStep, 500);
    }

    // ========================================
    // SISTEMA DE PERSONALIZAÇÃO DINÂMICA
    // ========================================
    
    /**
     * Carrega dados do questionário salvos no localStorage
     * @returns {Object} Dados do questionário e progresso
     */
    function loadQuestionnaireData() {
      try {
        const questionnaireData = JSON.parse(localStorage.getItem('questionnaireData') || '{}');
        const questionnaireProgress = JSON.parse(localStorage.getItem('questionnaireProgress') || '{}');
        
        // Adicionar dados de gênero do localStorage
        const sexo = localStorage.getItem('sexo') || '';
        if (sexo) {
          questionnaireData.sexo = sexo;
        }
        
        console.log('[PERSONALIZAÇÃO] Dados do questionário carregados:', questionnaireData);
        console.log('[PERSONALIZAÇÃO] Progresso do questionário:', questionnaireProgress);
        
        // Verificar se o questionário tem dados essenciais para ser considerado completo
        const hasEssentialData = questionnaireData.peso && questionnaireData.rendaMensal && questionnaireData.historicoMounjaro;
        
        return {
          data: questionnaireData,
          progress: questionnaireProgress,
          isComplete: hasEssentialData
        };
      } catch (error) {
        console.warn('[PERSONALIZAÇÃO] Erro ao carregar dados do localStorage:', error);
        return {
          data: {},
          progress: {},
          isComplete: false
        };
      }
    }

    /**
     * Gera título personalizado baseado no perfil do usuário
     * @param {Object} userData - Dados do questionário
     * @returns {Object} Título e descrição personalizados
     */
    function getPersonalizedTitle(userData) {
      const { peso, perdaPesoDesejada, rendaMensal, historicoMounjaro } = userData;
      
      // Títulos baseados no histórico e perfil
      if (historicoMounjaro === 'sim') {
        return {
          title: 'Solicitação de Continuidade do Tratamento - Programa Nacional',
          description: 'Confirmação da continuidade do seu tratamento com Mounjaro® através do Programa Nacional de Distribuição de Medicamentos Especializados do Ministério da Saúde',
          subtitle: 'Continuidade de tratamento previamente aprovada - Protocolo MS/ANVISA'
        };
      }
      
      // Títulos baseados no perfil de peso e objetivos
      const pesoNum = parseInt(peso?.replace(/\D/g, '') || '0');
      const perdaNum = parseInt(perdaPesoDesejada?.replace(/\D/g, '') || '0');
      
      if (pesoNum > 100 && perdaNum > 15) {
        return {
          title: 'Protocolo Especializado de Tratamento Metabólico - Programa Nacional',
          description: 'Acesso ao tratamento especializado com Mounjaro® para casos de alta complexidade metabólica, conforme diretrizes técnicas do Ministério da Saúde',
          subtitle: 'Tratamento especializado regulamentado - Alta prioridade clínica'
        };
      }
      
      if (rendaMensal && (rendaMensal.includes('até3000') || rendaMensal.includes('3001a5000'))) {
        return {
          title: 'Programa Social de Acesso a Medicamentos Especializados - MS',
          description: 'Acesso subsidiado ao Mounjaro® através do Programa Nacional de Distribuição, garantindo tratamento de qualidade independentemente da condição socioeconômica',
          subtitle: 'Programa social subsidiado pelo Ministério da Saúde'
        };
      }
      
      // Título padrão profissional
      return {
        title: 'Solicitação de Medicamento Regulamentado - Programa Nacional',
        description: 'Revise as informações completas e confirme sua solicitação do Mounjaro® via Programa Nacional de Distribuição de Medicamentos Especializados do Ministério da Saúde',
        subtitle: 'Medicamento regulamentado disponível exclusivamente através do Portal Oficial de Distribuição gov.br'
      };
    }

    /**
     * Gera benefícios personalizados baseados no perfil específico
     * @param {Object} userData - Dados do questionário
     * @returns {Array} Lista de benefícios personalizados
     */
    function getPersonalizedBenefits(userData) {
      const { peso, historicoMounjaro, formaAplicacao, confortoAplicacao, planoSaude, estimativaPerdaPeso, preferenciaContato } = userData;
      
      const baseBenefits = [
        {
          icon: 'fas fa-shield-alt',
          title: 'Programa Governamental Oficial',
          text: 'Distribuição controlada através do Portal Oficial gov.br, com total segurança regulatória'
        },
        {
          icon: 'fas fa-certificate',
          title: 'Aprovação ANVISA Completa',
          text: 'Medicamento com registro completo na ANVISA, seguindo todos os protocolos de segurança farmacêutica'
        }
      ];
      
      let personalizedBenefits = [...baseBenefits];
      
      // Benefícios baseados no histórico
      if (historicoMounjaro === 'sim') {
        personalizedBenefits.unshift({
          icon: 'fas fa-user-check',
          title: 'Continuidade Garantida do Tratamento',
          text: 'Seu histórico positivo com Mounjaro® garante prioridade na continuidade através do programa oficial'
        });
      }
      
      // Benefícios baseados no conforto com aplicação
      if (confortoAplicacao === 'muito_confortavel' || confortoAplicacao === 'confortavel') {
        personalizedBenefits.push({
          icon: 'fas fa-syringe',
          title: 'Sistema de Auto-Aplicação Aprovado',
          text: 'Dispositivo farmacêutico pré-calibrado para administração domiciliar segura e eficaz'
        });
      } else if (confortoAplicacao === 'pouco_confortavel' || confortoAplicacao === 'desconfortavel') {
        personalizedBenefits.push({
          icon: 'fas fa-hands-helping',
          title: 'Suporte Técnico Especializado',
          text: 'Orientação profissional gratuita para técnicas de aplicação e manejo adequado do dispositivo'
        });
      }
      
      // Benefícios baseados no plano de saúde
      if (planoSaude === 'nao') {
        personalizedBenefits.push({
          icon: 'fas fa-heart',
          title: 'Programa Social Inclusivo',
          text: 'Acesso garantido ao tratamento independentemente de plano de saúde, através do SUS'
        });
      }
      
      // Benefícios baseados na estimativa de perda de peso
      if (estimativaPerdaPeso && (estimativaPerdaPeso.includes('15') || estimativaPerdaPeso.includes('20'))) {
        personalizedBenefits.push({
          icon: 'fas fa-chart-line',
          title: 'Potencial Terapêutico Elevado',
          text: 'Seu perfil indica alta compatibilidade com os resultados clínicos esperados do tratamento'
        });
      }
      
      // Benefícios baseados na preferência de contato
      if (preferenciaContato === 'whatsapp' || preferenciaContato === 'telefone') {
        personalizedBenefits.push({
          icon: 'fas fa-phone-alt',
          title: 'Acompanhamento Personalizado',
          text: 'Suporte direto via telefone/WhatsApp para esclarecimento de dúvidas e acompanhamento do tratamento'
        });
      }
      
      return personalizedBenefits.slice(0, 6); // Limitar a 6 benefícios principais
    }

    /**
     * Gera CTA otimizada baseada no perfil psicológico
     * @param {Object} userData - Dados do questionário
     * @returns {Object} Textos de CTA personalizados
     */
    function getPersonalizedCTA(userData) {
      const { rendaMensal, historicoMounjaro, inicioTratamento, planoSaude } = userData;
      
      // CTA para usuários com histórico
      if (historicoMounjaro === 'sim') {
        return {
          primaryButton: 'Confirmar Continuidade do Tratamento',
          secondaryText: 'Mantenha a continuidade do seu tratamento através do programa oficial',
          urgencyText: 'Confirme hoje para garantir a continuidade sem interrupções'
        };
      }
      
      // CTA para início imediato
      if (inicioTratamento === 'imediatamente') {
        return {
          primaryButton: 'Iniciar Tratamento Agora',
          secondaryText: 'Processo rápido e seguro através do portal governamental oficial',
          urgencyText: 'Início imediato disponível - Confirme sua solicitação'
        };
      }
      
      // CTA para renda mais baixa (apelo ao programa social)
      if (rendaMensal && (rendaMensal.includes('até3000') || rendaMensal.includes('3001a5000'))) {
        return {
          primaryButton: 'Acessar Programa Social',
          secondaryText: 'Tratamento subsidiado através do programa governamental de distribuição',
          urgencyText: 'Vagas limitadas no programa social - Confirme sua participação'
        };
      }
      
      // CTA para usuários sem plano de saúde
      if (planoSaude === 'nao') {
        return {
          primaryButton: 'Confirmar Acesso via SUS',
          secondaryText: 'Tratamento gratuito garantido através do Sistema Único de Saúde',
          urgencyText: 'Acesso garantido pelo SUS - Confirme sua solicitação'
        };
      }
      
      // CTA padrão profissional
      return {
        primaryButton: 'Confirmar Solicitação Oficial',
        secondaryText: 'Processo seguro e regulamentado através do portal gov.br',
        urgencyText: 'Confirme sua solicitação através do canal oficial'
      };
    }

    /**
     * Personaliza mensagens de urgência baseadas no perfil de decisão
     * @param {Object} userData - Dados do questionário
     * @returns {Object} Mensagens de urgência personalizadas
     */
    function getPersonalizedUrgency(userData) {
      const { rendaMensal, peso, historicoMounjaro, inicioTratamento } = userData;
      
      // Urgência para continuidade de tratamento
      if (historicoMounjaro === 'sim') {
        return {
          type: 'continuity',
          title: 'Continuidade Prioritária',
          message: 'Pacientes com histórico no Mounjaro® têm prioridade na renovação através do programa oficial',
          action: 'Confirme hoje para evitar interrupções no tratamento'
        };
      }
      
      // Urgência baseada no início imediato
      if (inicioTratamento === 'imediatamente') {
        return {
          type: 'immediate',
          title: 'Início Imediato Disponível',
          message: 'Protocolo de início imediato disponível através do programa de distribuição controlada',
          action: 'Confirme agora para iniciar o tratamento sem demoras'
        };
      }
      
      // Urgência baseada no programa social
      if (rendaMensal && (rendaMensal.includes('até3000') || rendaMensal.includes('3001a5000'))) {
        return {
          type: 'social',
          title: 'Programa Social com Cotas Limitadas',
          message: 'O Programa Nacional de Distribuição possui cotas mensais limitadas para cada região',
          action: 'Garanta sua vaga no programa subsidiado'
        };
      }
      
      // Urgência padrão baseada na disponibilidade regional
      return {
        type: 'regional',
        title: 'Disponibilidade Regional Controlada',
        message: 'A distribuição é planejada conforme diretrizes epidemiológicas regionais do Ministério da Saúde',
        action: 'Confirme sua solicitação dentro da cota regional disponível'
      };
    }

    /**
     * Verifica se o usuário tem direito ao acesso gratuito baseado nos dados do questionário
     * @param {Object} userData - Dados do usuário do questionário de saúde
     * @returns {boolean} - True se elegível para acesso gratuito
     */
    function isEligibleForFreeAccess(userData) {
      console.log('[ACESSO GRATUITO] Verificando elegibilidade:', userData);
      
      // Critério 1: Renda mensal até R$ 5.000
      const rendaBaixa = userData.rendaMensal && 
        (userData.rendaMensal.includes('até3000') || userData.rendaMensal.includes('3001a5000'));
      
      // Critério 2: Plano de saúde SUS ou não possui plano
      const planoSocialPublico = userData.planoSaude && 
        (userData.planoSaude === 'sus' || userData.planoSaude === 'naoTenho');
      
      // Critério 3: Histórico de Mounjaro (continuidade garantida)
      const continuidadeTratamento = userData.historicoMounjaro === 'sim';
      
      // Critério 4: Qualquer condição médica específica (diabetes, obesidade, etc.)
      const condicaoMedicaEspecifica = userData.condicoesSaude && 
        Array.isArray(userData.condicoesSaude) && userData.condicoesSaude.length > 0;
      
      // Elegível se atender pelo menos um dos critérios principais
      const elegivel = rendaBaixa || planoSocialPublico || continuidadeTratamento || condicaoMedicaEspecifica;
      
      console.log('[ACESSO GRATUITO] Critérios:', {
        rendaBaixa,
        planoSocialPublico, 
        continuidadeTratamento,
        condicaoMedicaEspecifica,
        elegivel
      });
      
      return elegivel;
    }

    /**
     * Aplica o sistema de preços gratuitos para usuários elegíveis
     * @param {Object} userData - Dados do usuário do questionário
     */
    function applyFreeAccessPricing(userData) {
      console.log('[ACESSO GRATUITO] Aplicando sistema de preços gratuitos');
      
      try {
        // 1. Modificar preço principal
        const mainPriceElement = document.getElementById('main-price');
        if (mainPriceElement) {
          mainPriceElement.innerHTML = 'Acesso Gratuito via Programa Governamental: <strong>R$ 0,00</strong>';
        }
        
        // 2. Modificar preço de referência
        const referencePriceElement = mainPriceElement?.previousElementSibling;
        if (referencePriceElement && referencePriceElement.textContent.includes('Valor de Referência')) {
          referencePriceElement.textContent = 'Programa Nacional - SUS/MS: Subsídio Integral';
          referencePriceElement.classList.remove('line-through', 'text-gray-500');
          referencePriceElement.classList.add('text-green-600', 'font-medium');
        }
        
        // 3. Modificar disclaimer do preço
        const disclaimerElement = mainPriceElement?.nextElementSibling;
        if (disclaimerElement && disclaimerElement.textContent.includes('subsidiado')) {
          disclaimerElement.textContent = '* Acesso garantido pelo Programa Nacional de Distribuição - SUS/MS';
        }
        
        // 4. Modificar todos os elementos de preço do produto
        const productPriceElements = ['product-price', 'total-price'];
        productPriceElements.forEach(elementId => {
          const element = document.getElementById(elementId);
          if (element) {
            element.textContent = 'R$ 0,00';
            element.classList.add('text-green-600', 'font-bold');
          }
        });
        
        // 5. Modificar elemento de total com subsídio
        const totalAmountElement = document.getElementById('totalAmount');
        if (totalAmountElement) {
          totalAmountElement.textContent = 'R$ 0,00';
          totalAmountElement.classList.add('text-green-600');
        }
        
        // 6. Modificar texto do total (usando método nativo ao invés de :contains)
        const allSpans = document.querySelectorAll('span');
        let totalText = null;
        for (const span of allSpans) {
          if (span.textContent && span.textContent.includes('Total com Subsídio Governamental')) {
            totalText = span;
            break;
          }
        }
        if (totalText) {
          totalText.textContent = 'Acesso Gratuito - SUS/MS';
        } else {
          // Buscar pela estrutura conhecida
          const totalContainer = totalAmountElement?.parentElement;
          if (totalContainer) {
            const totalSpan = totalContainer.querySelector('span:first-child');
            if (totalSpan && totalSpan.textContent && totalSpan.textContent.includes('Total')) {
              totalSpan.textContent = 'Acesso Gratuito - SUS/MS';
            }
          }
        }
        
        // 7. Modificar texto explicativo do valor único (usando método nativo)
        const allParas = document.querySelectorAll('p');
        let uniqueValueText = null;
        for (const p of allParas) {
          if (p.textContent && p.textContent.includes('Valor único subsidiado')) {
            uniqueValueText = p;
            break;
          }
        }
        if (uniqueValueText) {
          uniqueValueText.textContent = 'Acesso gratuito garantido pelo Programa Nacional, sem custos para o paciente';
        }
        
        // 8. Modificar preços de entrega para R$ 0,00 (entrega também gratuita)
        const deliveryPrices = document.querySelectorAll('.shipping-option .text-right p');
        deliveryPrices.forEach(priceElement => {
          if (priceElement.textContent.includes('R$') && !priceElement.textContent.includes('0,00')) {
            priceElement.textContent = 'R$ 0,00';
            priceElement.classList.add('text-green-600', 'font-medium');
          }
        });
        
        // 9. Adicionar indicador visual de acesso gratuito
        const headerSection = document.querySelector('.mb-6');
        if (headerSection) {
          const freeAccessIndicator = document.createElement('div');
          freeAccessIndicator.className = 'bg-green-50 border border-green-200 rounded-lg p-4 mt-4';
          freeAccessIndicator.innerHTML = `
            <div class="flex items-center text-green-800">
              <i class="fas fa-check-circle text-green-600 mr-3 text-lg"></i>
              <div>
                <h4 class="font-semibold text-green-900 mb-1">Acesso Gratuito Aprovado</h4>
                <p class="text-sm text-green-700">Você foi aprovado(a) para o Programa Nacional de Distribuição Gratuita de Medicamentos Especializados do SUS. Todos os custos são cobertos pelo Ministério da Saúde.</p>
              </div>
            </div>
          `;
          headerSection.appendChild(freeAccessIndicator);
        }
        
        console.log('[ACESSO GRATUITO] Sistema de preços gratuitos aplicado com sucesso');
        
      } catch (error) {
        console.error('[ACESSO GRATUITO] Erro ao aplicar sistema de preços gratuitos:', error);
      }
    }

    /**
     * Aplica todas as personalizações na página
     */
    function applyPersonalization() {
      console.log('[PERSONALIZAÇÃO] Iniciando aplicação das personalizações...');
      
      const questionnaireInfo = loadQuestionnaireData();
      
      if (!questionnaireInfo.isComplete) {
        console.log('[PERSONALIZAÇÃO] Questionário não completado, usando conteúdo padrão');
        return;
      }
      
      const userData = questionnaireInfo.data;
      
      try {
        // 1. Personalizar título e descrição principal
        const titleContent = getPersonalizedTitle(userData);
        const mainTitle = document.querySelector('h1');
        const mainDescription = document.querySelector('h1 + p');
        const subtitle = document.querySelector('h1 + p + p');
        
        if (mainTitle) {
          mainTitle.textContent = titleContent.title;
          console.log('[PERSONALIZAÇÃO] Título atualizado:', titleContent.title);
        }
        
        if (mainDescription) {
          mainDescription.textContent = titleContent.description;
          console.log('[PERSONALIZAÇÃO] Descrição atualizada');
        }
        
        if (subtitle) {
          subtitle.textContent = titleContent.subtitle;
          console.log('[PERSONALIZAÇÃO] Subtítulo atualizado');
        }
        
        // 2. Personalizar benefícios
        const personalizedBenefits = getPersonalizedBenefits(userData);
        const benefitsContainer = document.querySelector('.benefits-list');
        
        if (benefitsContainer && personalizedBenefits.length > 0) {
          // Limpar benefícios existentes
          benefitsContainer.innerHTML = '';
          
          // Adicionar benefícios personalizados
          personalizedBenefits.forEach(benefit => {
            const benefitElement = document.createElement('div');
            benefitElement.className = 'benefit-item';
            benefitElement.innerHTML = `
              <h4 class="benefit-item-title">
                <i class="${benefit.icon}"></i> ${benefit.title}
              </h4>
              <p class="benefit-item-text">${benefit.text}</p>
            `;
            benefitsContainer.appendChild(benefitElement);
          });
          
          console.log('[PERSONALIZAÇÃO] Benefícios personalizados aplicados:', personalizedBenefits.length);
        }
        
        // 3. Personalizar CTAs
        const ctaContent = getPersonalizedCTA(userData);
        const primaryButton = document.querySelector('#proceed-button, .btn-primary');
        const checkoutButton = document.querySelector('#checkout-btn');
        
        if (primaryButton) {
          primaryButton.textContent = ctaContent.primaryButton;
          console.log('[PERSONALIZAÇÃO] CTA principal atualizado:', ctaContent.primaryButton);
        }
        
        if (checkoutButton) {
          checkoutButton.textContent = ctaContent.primaryButton;
          console.log('[PERSONALIZAÇÃO] Botão de checkout atualizado');
        }
        
        // 4. Personalizar mensagens de urgência
        const urgencyContent = getPersonalizedUrgency(userData);
        const stockMessage = document.getElementById('stock-message');
        const stockExplanation = document.getElementById('stock-explanation');
        
        if (stockMessage) {
          stockMessage.textContent = urgencyContent.message;
          console.log('[PERSONALIZAÇÃO] Mensagem de urgência atualizada');
        }
        
        if (stockExplanation) {
          stockExplanation.textContent = urgencyContent.action;
          stockExplanation.style.display = 'block';
        }
        
        // 5. Verificar e aplicar sistema de acesso gratuito
        if (isEligibleForFreeAccess(userData)) {
          console.log('[PERSONALIZAÇÃO] Usuário elegível para acesso gratuito, aplicando sistema...');
          applyFreeAccessPricing(userData);
        } else {
          console.log('[PERSONALIZAÇÃO] Usuário não elegível para acesso gratuito, mantendo sistema de preços padrão');
        }
        
        // 6. Adicionar indicador de personalização
        const personalizationIndicator = document.createElement('div');
        personalizationIndicator.className = 'text-xs text-blue-600 font-medium mt-2 flex items-center';
        personalizationIndicator.innerHTML = `
          <i class="fas fa-user-cog mr-1"></i>
          Conteúdo personalizado baseado no seu perfil de saúde
        `;
        
        const headerSection = document.querySelector('.mb-6');
        if (headerSection && !isEligibleForFreeAccess(userData)) {
          headerSection.appendChild(personalizationIndicator);
        }
        
        // 7. Personalização baseada no gênero
        personalizeContentByGender(userData);
        
        console.log('[PERSONALIZAÇÃO] Sistema de personalização aplicado com sucesso!');
        
        // 8. Logging para debugging
        console.log('[PERSONALIZAÇÃO] Perfil do usuário:', {
          peso: userData.peso,
          rendaMensal: userData.rendaMensal,
          historicoMounjaro: userData.historicoMounjaro,
          inicioTratamento: userData.inicioTratamento,
          sexo: userData.sexo
        });
        
      } catch (error) {
        console.error('[PERSONALIZAÇÃO] Erro ao aplicar personalizações:', error);
      }
    }

    /**
     * Função principal para personalizar todo o conteúdo da página
     */
    function personalizePageContent() {
      // Aguardar o DOM estar completamente carregado
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyPersonalization);
      } else {
        applyPersonalization();
      }
      
      // Aplicar personalizações também quando dados do localStorage mudarem
      window.addEventListener('storage', function(e) {
        if (e.key === 'questionnaireData' || e.key === 'questionnaireProgress') {
          console.log('[PERSONALIZAÇÃO] Dados do questionário atualizados, reaplicando personalizações...');
          setTimeout(applyPersonalization, 100);
        }
      });
    }

    /**
     * Personaliza conteúdo baseado no gênero do usuário
     * @param {Object} userData - Dados do usuário incluindo sexo
     */
    function personalizeContentByGender(userData) {
      try {
        const sexo = userData.sexo || '';
        
        if (sexo === 'F' || sexo === 'M') {
          const isFeminino = sexo === 'F';
          
          // Personalizar indicador de personalização
          const personalizationIndicator = document.querySelector('.text-xs.text-blue-600');
          if (personalizationIndicator) {
            const personalizado = isFeminino ? 'personalizada' : 'personalizado';
            personalizationIndicator.innerHTML = `
              <i class="fas fa-user-cog mr-1"></i>
              Conteúdo ${personalizado} baseado no seu perfil de saúde
            `;
          }
          
          // Personalizar textos de CTAs que mencionam "adequado"
          const ctaElements = document.querySelectorAll('[data-personalizable="true"]');
          ctaElements.forEach(element => {
            let text = element.innerHTML;
            if (text.includes('adequado')) {
              const adequado = isFeminino ? 'adequada' : 'adequado';
              text = text.replace(/adequado/g, adequado);
              element.innerHTML = text;
            }
            if (text.includes('preparado')) {
              const preparado = isFeminino ? 'preparada' : 'preparado';
              text = text.replace(/preparado/g, preparado);
              element.innerHTML = text;
            }
          });
          
          console.log(`[PERSONALIZAÇÃO] Conteúdo personalizado para gênero: ${isFeminino ? 'feminino' : 'masculino'}`);
        }
      } catch (error) {
        console.error('[PERSONALIZAÇÃO] Erro ao personalizar por gênero:', error);
      }
    }

    // ========================================
    // INICIALIZAÇÃO DO SISTEMA DE PERSONALIZAÇÃO
    // ========================================
    
    console.log('[PERSONALIZAÇÃO] Sistema de personalização dinâmica pronto');

    // ========================================
    // FUNÇÃO DE CÁLCULO DE PREÇO E DOSAGEM VIA API
    // ========================================
    
    // Variáveis globais para armazenar dados calculados
    let calculatedPrice = '197.90';
    let recommendedDosage = '5mg';
    let dosageReason = '';
    let nextEvaluation = '';
    
    /**
     * Calcula preço e dosagem via API /api/calcular-preco
     * @returns {Promise<Object>} Dados calculados da API
     */
    async function calcularPrecoEDosagemViaAPI() {
      try {
        const questionnaireData = JSON.parse(localStorage.getItem('questionnaireData') || '{}');
        console.log('[API CALCULAR] Dados do questionário para cálculo:', questionnaireData);
        
        // Se não há dados do questionário, usar valores padrão
        if (!questionnaireData || Object.keys(questionnaireData).length === 0) {
          console.log('[API CALCULAR] Sem dados do questionário, usando valores padrão');
          return {
            success: true,
            data: {
              preco_base: 197.90,
              dosagemRecomendada: '5mg',
              razaoRecomendacao: 'Dose padrão inicial recomendada',
              proximaAvaliacao: '4 semanas'
            }
          };
        }
        
        // Fazer chamada para a API
        console.log('[API CALCULAR] Chamando API /api/calcular-preco...');
        const response = await fetch('/api/calcular-preco', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(questionnaireData)
        });
        
        const data = await response.json();
        console.log('[API CALCULAR] Resposta da API:', data);
        
        if (data.success && data.data) {
          // Armazenar valores calculados globalmente
          calculatedPrice = data.data.preco_base.toString();
          recommendedDosage = data.data.dosagemRecomendada;
          dosageReason = data.data.razaoRecomendacao;
          nextEvaluation = data.data.proximaAvaliacao;
          
          console.log('[API CALCULAR] Valores calculados - Preço:', calculatedPrice, 'Dosagem:', recommendedDosage);
          
          // Salvar preço calculado no localStorage para outras páginas
          localStorage.setItem('calculatedPrice', calculatedPrice);
          
          // Atualizar elementos da página
          atualizarElementosComValoresCalculados();
          
          return data;
        } else {
          throw new Error(data.error || 'Erro na API');
        }
        
      } catch (error) {
        console.error('[API CALCULAR] Erro ao chamar API:', error);
        // Em caso de erro, usar valores padrão
        calculatedPrice = '197.90';
        recommendedDosage = '5mg';
        dosageReason = 'Dose inicial padrão devido a erro no processamento';
        nextEvaluation = '4 semanas';
        
        return {
          success: false,
          error: error.message
        };
      }
    }
    
    /**
     * Atualiza elementos da página com valores calculados
     */
    function atualizarElementosComValoresCalculados() {
      try {
        console.log('[ATUALIZAR] Atualizando elementos da página com valores calculados...');
        console.log('[ATUALIZAR] Preço calculado:', calculatedPrice, 'Dosagem:', recommendedDosage);
        
        // Formatação segura do preço
        const priceNum = Number(calculatedPrice);
        const formattedPrice = new Intl.NumberFormat('pt-BR', {
          style: 'currency', 
          currency: 'BRL'
        }).format(priceNum);
        
        // Lista de todos os elementos que mostram preço
        const priceElements = [
          'totalAmount',
          'product-price', 
          'total-price',
          'main-price'
        ];
        
        // Atualizar todos os elementos de preço
        priceElements.forEach(elementId => {
          const element = document.getElementById(elementId);
          if (element) {
            // Para o main-price, manter o texto "Valor com Subsídio:"
            if (elementId === 'main-price') {
              element.textContent = `Valor com Subsídio: ${formattedPrice}`;
            } else {
              element.textContent = formattedPrice;
            }
            console.log(`[ATUALIZAR] ${elementId} atualizado para: ${formattedPrice}`);
          } else {
            // Silenciar aviso - elemento pode ser opcional no layout
            console.log(`[ATUALIZAR] Elemento ${elementId} não encontrado (opcional)`);
          }
        });
        
        // Atualizar resumo do produto com dosagem recomendada
        const productSummaryElement = document.getElementById('product-dosage-summary');
        if (productSummaryElement) {
          productSummaryElement.textContent = `Mounjaro® ${recommendedDosage} (4 dispositivos injetáveis)`;
          console.log('[ATUALIZAR] Resumo do produto atualizado:', productSummaryElement.textContent);
        }
        
        // Atualizar apresentação do produto com dosagem recomendada
        const productPresentationElement = document.getElementById('product-dosage-presentation');
        if (productPresentationElement) {
          productPresentationElement.textContent = `4 Canetas injetáveis de ${recommendedDosage}`;
          console.log('[ATUALIZAR] Apresentação do produto atualizada:', productPresentationElement.textContent);
        }
        
        // ✅ CORREÇÃO BUG #4: Marcar dosagem recomendada APENAS VISUALMENTE
        // Não selecionar automaticamente, apenas indicar qual é recomendada
        marcarDosagemRecomendada(recommendedDosage);
        
        // ✅ CORREÇÃO BUG #7: Selecionar dose inicial SOMENTE se não houver seleção prévia
        if (!localStorage.getItem('selected_dosage') && !window.selecaoManualFeita) {
          const dosageInicial = document.querySelector('input[value="2.5mg"]');
          if (dosageInicial) {
            dosageInicial.checked = true;
            localStorage.setItem('selected_dosage', '2.5mg');
            // ✅ CORREÇÃO PIX: Salvar preço correspondente à dose inicial
            const precoInicial = TABELA_PRECOS['2.5mg'] || 147.90;
            localStorage.setItem('calculatedPrice', precoInicial.toString());
            console.log('[DOSAGEM] Dose inicial 2.5mg selecionada (primeira vez)');
            console.log('[DOSAGEM] Preço inicial: R$', precoInicial.toFixed(2));
            console.log('[DOSAGEM] Dose recomendada:', recommendedDosage, '(marcada visualmente)');
          }
        } else {
          const dosagemMantida = localStorage.getItem('selected_dosage');
          console.log('[DOSAGEM] Seleção existente mantida:', dosagemMantida);
          // ✅ CORREÇÃO PIX: Garantir que o preço está correto para a dosagem mantida
          if (dosagemMantida && TABELA_PRECOS[dosagemMantida]) {
            const precoMantido = TABELA_PRECOS[dosagemMantida];
            const precoAtual = parseFloat(localStorage.getItem('calculatedPrice') || '0');
            if (precoAtual !== precoMantido) {
              localStorage.setItem('calculatedPrice', precoMantido.toString());
              console.log('[DOSAGEM] Preço corrigido para:', precoMantido);
            }
          }
        }
        
        // Exibir razão da recomendação
        exibirRazaoRecomendacao();
        
        console.log('[ATUALIZAR] Todos os elementos atualizados com sucesso');
        console.log('[ATUALIZAR] Valores finais - Preço:', formattedPrice, 'Dosagem:', recommendedDosage);
        
      } catch (error) {
        console.error('[ATUALIZAR] Erro ao atualizar elementos:', error);
      }
    }
    
    /**
     * Marca a dosagem recomendada no seletor
     * ✅ CORRIGIDO: Agora respeita seleção manual do usuário
     */
    function marcarDosagemRecomendada(dosagem) {
      try {
        // ✅ CORREÇÃO BUG #3: Verificar se usuário já fez seleção manual
        if (window.selecaoManualFeita) {
          console.log('[DOSAGEM] Seleção manual detectada, não sobrescrever');
          return; // NÃO sobrescrever escolha do usuário!
        }
        
        // ✅ CORREÇÃO BUG #3: Verificar se já existe seleção no localStorage
        const selecaoExistente = localStorage.getItem('selected_dosage');
        if (selecaoExistente) {
          console.log('[DOSAGEM] Já existe seleção salva:', selecaoExistente, '- Mantendo');
          return; // NÃO sobrescrever escolha salva!
        }
        
        // Apenas marcar VISUALMENTE como recomendada (sem alterar checked ou localStorage)
        const dosageOption = document.querySelector(`input[value="${dosagem}"]`);
        if (dosageOption) {
          // Adicionar classe visual sem marcar o radio button
          dosageOption.closest('.dosage-option').classList.add('recommended');
          console.log('[DOSAGEM] Dosagem recomendada marcada VISUALMENTE (sem selecionar):', dosagem);
        }
        
      } catch (error) {
        console.error('[DOSAGEM] Erro ao marcar dosagem recomendada:', error);
      }
    }
    
    /**
     * Exibe a razão da recomendação médica
     */
    function exibirRazaoRecomendacao() {
      try {
        // Criar ou atualizar elemento de razão da recomendação
        let reasonElement = document.getElementById('dosage-recommendation-reason');
        
        if (!reasonElement) {
          reasonElement = document.createElement('div');
          reasonElement.id = 'dosage-recommendation-reason';
          reasonElement.className = 'mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg';
          
          // Inserir após o seletor de dosagem
          const dosageSelector = document.querySelector('.grid.grid-cols-4.gap-2');
          if (dosageSelector && dosageSelector.parentNode) {
            dosageSelector.parentNode.insertBefore(reasonElement, dosageSelector.nextSibling);
          }
        }
        
        reasonElement.innerHTML = `
          <div class="flex items-start space-x-2">
            <div class="flex-shrink-0 mt-0.5">
              <i class="fas fa-user-md text-blue-600 text-sm"></i>
            </div>
            <div class="flex-1">
              <h4 class="text-sm font-medium text-blue-800 mb-1">Recomendação Médica Personalizada</h4>
              <p class="text-xs text-blue-700">${dosageReason}</p>
              ${nextEvaluation ? `<p class="text-xs text-blue-600 mt-1"><strong>Próxima avaliação:</strong> ${nextEvaluation}</p>` : ''}
            </div>
          </div>
        `;
        
        console.log('[RECOMENDAÇÃO] Razão da recomendação exibida');
        
      } catch (error) {
        console.error('[RECOMENDAÇÃO] Erro ao exibir razão:', error);
      }
    }
    
    /**
     * Função compatível com o código existente
     * @returns {string} Preço calculado
     */
    function calcularPrecoBaseadoNoQuestionario() {
      return calculatedPrice;
    }
    
    /**
     * Gera explicação personalizada do subsídio baseada no questionário
     */
    function generatePersonalizedSubsidyExplanation() {
      try {
        const questionnaireData = JSON.parse(localStorage.getItem('questionnaireData') || '{}');
        console.log('[PERSONALIZAÇÃO] Gerando explicação personalizada:', questionnaireData);
        
        const { peso, rendaMensal, historicoMounjaro, perdaPesoDesejada, diabetes, objetivos } = questionnaireData;
        
        // Obter preço calculado dinamicamente
        const precoCalculadoNum = parseFloat(calculatedPrice) || 197.90;
        const precoFormatado = `R$ ${precoCalculadoNum.toFixed(2).replace('.', ',')}`;
        console.log('[PERSONALIZAÇÃO] Usando preço calculado:', precoFormatado);
        
        let personalizedText = '';
        
        // Personalização baseada no histórico de Mounjaro
        if (historicoMounjaro === 'sim') {
          personalizedText += `
            <p>
              <strong>Retorno ao programa governamental:</strong> Como você já utilizou Mounjaro anteriormente, 
              este valor reduzido de ${precoFormatado} representa sua reintegração no programa nacional, permitindo 
              acesso continuado ao tratamento com os melhores preços disponíveis no país.
            </p>
          `;
        }
        
        // Mapear valores categóricos para numéricos
        const pesoMapping = {
          'menos60': { min: 45, max: 59, display: '50-60kg' },
          '60a80': { min: 60, max: 80, display: '60-80kg' },
          '81a100': { min: 81, max: 100, display: '81-100kg' },
          'mais100': { min: 100, max: 120, display: '100kg+' }
        };
        
        const perdaMapping = {
          '5a10': { min: 5, max: 10, display: '5-10kg' },
          '11a15': { min: 11, max: 15, display: '11-15kg' },
          '16a20': { min: 16, max: 20, display: '16-20kg' },
          'mais20': { min: 20, max: 30, display: '20kg+' }
        };
        
        const pesoRange = pesoMapping[peso];
        const perdaRange = perdaMapping[perdaPesoDesejada];
        
        // Personalização baseada no peso e objetivos
        if (pesoRange && perdaRange) {
          const pesoMedio = (pesoRange.min + pesoRange.max) / 2;
          const perdaMedia = (perdaRange.min + perdaRange.max) / 2;
          
          if (peso === 'mais100' && (perdaPesoDesejada === 'mais20' || perdaPesoDesejada === '16a20')) {
            personalizedText += `
              <p>
                <strong>Tratamento especializado para sua meta:</strong> Considerando seu perfil de ${pesoRange.display} 
                e objetivo de reduzir ${perdaRange.display}, o programa governamental oferece acompanhamento intensivo 
                que normalmente custaria mais de R$ 5.000,00 em clínicas privadas, agora por apenas ${precoFormatado}.
              </p>
            `;
          } else if (peso === '81a100' || peso === 'mais100') {
            personalizedText += `
              <p>
                <strong>Suporte personalizado:</strong> Para pacientes na faixa de ${pesoRange.display}, o programa 
                inclui monitoramento médico especializado que garante resultados seguros e eficazes, 
                um acompanhamento que custaria mais de R$ 3.000,00 no sistema privado.
              </p>
            `;
          } else if (peso === '60a80') {
            personalizedText += `
              <p>
                <strong>Programa otimizado:</strong> Para seu perfil de ${pesoRange.display}, o tratamento foi 
                personalizado para garantir os melhores resultados com total segurança, incluindo acompanhamento 
                que custaria mais de R$ 2.500,00 em clínicas particulares.
              </p>
            `;
          }
        }
        
        // Personalização baseada na renda
        if (rendaMensal === 'menos2000' || rendaMensal === '2000a5000') {
          personalizedText += `
            <p>
              <strong>Acesso garantido independente da renda:</strong> O programa foi criado especificamente 
              para garantir que pacientes com diferentes perfis de renda tenham acesso igual ao tratamento. 
              Mesmo com renda limitada, você tem direito ao mesmo atendimento premium oferecido a todos os participantes.
            </p>
          `;
        }
        
        // Personalização baseada em diabetes
        if (diabetes === 'sim' || diabetes === 'tipo2') {
          personalizedText += `
            <p>
              <strong>Tratamento integrado para diabetes:</strong> Como você possui diabetes, o valor inclui 
              monitoramento específico da glicemia, ajustes de HbA1c e coordenação com sua equipe médica atual, 
              garantindo um cuidado completo que normalmente requer múltiplas especialidades médicas.
            </p>
          `;
        }
        
        // Texto padrão se não houver dados específicos
        if (!personalizedText) {
          personalizedText = `
            <p>
              <strong>Programa personalizado:</strong> Baseado no seu perfil de saúde único, o programa 
              governamental oferece tratamento sob medida com acompanhamento médico especializado que 
              normalmente custaria mais de R$ 4.000,00 mensais em clínicas privadas.
            </p>
          `;
        }
        
        return personalizedText;
        
      } catch (error) {
        console.error('[PERSONALIZAÇÃO] Erro ao gerar explicação:', error);
        return '';
      }
    }
    
    /**
     * Atualiza a explicação do subsídio com personalização
     */
    function updatePersonalizedSubsidyExplanation() {
      try {
        const explanationContainer = document.getElementById('personalized-subsidy-explanation');
        if (!explanationContainer) return;
        
        // Obter preço calculado dinamicamente
        const precoCalculadoNum = parseFloat(calculatedPrice) || 197.90;
        const precoFormatado = `R$ ${precoCalculadoNum.toFixed(2).replace('.', ',')}`;
        
        const personalizedText = generatePersonalizedSubsidyExplanation();
        
        explanationContainer.innerHTML = `
          <p>
            <strong>Economia de R$ 2.202,10 (91.7% de redução)</strong> — O subsídio governamental 
            cobre a maior parte do custo do medicamento, tornando-o acessível para pacientes que 
            atendem aos critérios do programa nacional.
          </p>
          ${personalizedText}
          <p>
            <strong>Pagamento único, sem recorrência:</strong> Este valor cobre o tratamento completo de 4 semanas 
            (1 mês) com 4 canetas injetáveis pré-calibradas. Não há mensalidades, assinaturas ou 
            custos ocultos. <strong>O próximo ciclo será 100% gratuito</strong> após avaliação médica positiva.
          </p>
          <p>
            <strong>Por que é necessário este pagamento inicial?</strong> Embora o programa seja subsidiado, 
            o valor de ${precoFormatado} cobre custos operacionais essenciais: logística de distribuição com 
            cadeia fria farmacêutica, acompanhamento médico personalizado, sistema de rastreabilidade 
            nacional e estrutura de atendimento 24h. Estes custos não podem ser cobertos integralmente 
            pelo SUS devido às limitações orçamentárias específicas para medicamentos especializados.
          </p>
          <p>
            <strong>Acompanhamento médico incluído:</strong> O valor já inclui consultas de acompanhamento, 
            monitoramento de resultados e ajustes de dosagem conforme protocolo clínico estabelecido 
            pelo Ministério da Saúde, sem custos adicionais.
          </p>
        `;
        
        console.log('[PERSONALIZAÇÃO] Explicação do subsídio personalizada aplicada');
        
      } catch (error) {
        console.error('[PERSONALIZAÇÃO] Erro ao atualizar explicação:', error);
      }
    }

    // Prevenir fechamento acidental do loader
    document.addEventListener('keydown', function(e) {
      const loader = document.getElementById('governmentalLoader');
      if (loader && !loader.classList.contains('hidden')) {
        // Bloquear Escape, F5, Ctrl+R durante o processamento
        if (e.key === 'Escape' || e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
          e.preventDefault();
          return false;
        }
      }
    });
    
    // Inicializar exibição do paciente autorizado quando a página carregar
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[COMPRA] Página de compra carregada, verificando paciente autorizado...');
      displayAuthorizedPatient();
      
      // Calcular preço e dosagem via API
      console.log('[COMPRA] Iniciando cálculo de preço e dosagem...');
      calcularPrecoEDosagemViaAPI().then((result) => {
        if (result.success) {
          console.log('[COMPRA] Cálculo de preço e dosagem concluído com sucesso');
        } else {
          console.warn('[COMPRA] Falha no cálculo, usando valores padrão');
        }
      }).catch((error) => {
        console.error('[COMPRA] Erro no cálculo de preço e dosagem:', error);
      });
      
      // Aplicar personalização do subsídio
      console.log('[COMPRA] Aplicando personalização da explicação do subsídio...');
      setTimeout(() => {
        updatePersonalizedSubsidyExplanation();
      }, 500); // Pequeno delay para garantir que os dados estejam carregados
    });

  </script>
  <!-- Carregar o script da API de farmácia -->
  <script src="./index_files/pharmacy_api_client.js"></script>

</div>
 <footer class="bg-[#0B2341] text-white relative" style="z-index: 10;">
  <div class="w-full px-4 py-4 pt-[64px]">
    <!-- ANVISA Logo -->
    <img src="https://www.gov.br/++theme++padrao_govbr/img/govbr.png" alt="Gov.br Logo" class="w-[165px] h-[60px] mb-[52px]">
    <div class="w-full border-b border-white"></div>
    
    <!-- MAIS INFORMAÇÕES Section -->
    <div class="accordion-item">
      <div class="flex items-center justify-between pt-[8px] pl-[4px] pb-[8px] cursor-pointer accordion-trigger" onclick="toggleAccordion(&#39;mais-info&#39;)">
        <span class="font-bold text-base hover:text-gray-300 transition-colors">MAIS INFORMAÇÕES</span>
        <i class="fas fa-chevron-down text-lg accordion-chevron transition-transform duration-300 mr-1" id="chevron-mais-info"></i>
      </div>
      <div class="accordion-content pb-4 hidden" id="content-mais-info">
        <ul class="space-y-2.5 text-base">
          <li>
            <div class="flex items-center justify-between cursor-pointer hover:text-white transition-colors" onclick="toggleSubMenu(&#39;vigilancia-sanitaria&#39;)">
              <span class="text-gray-300">Vigilância Sanitária no Brasil</span>
              <i class="fas fa-chevron-down text-sm transition-transform duration-300" id="chevron-vigilancia-sanitaria"></i>
            </div>
            <div class="ml-4 mt-2 space-y-1 hidden" id="submenu-vigilancia-sanitaria">
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">História da ANVISA</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Marco Regulatório</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Competências</a></div>
            </div>
          </li>
          <li>
            <div class="flex items-center justify-between cursor-pointer hover:text-white transition-colors" onclick="toggleSubMenu(&#39;medicamentos-anvisa&#39;)">
              <span class="text-gray-300">Registro de Medicamentos</span>
              <i class="fas fa-chevron-down text-sm transition-transform duration-300" id="chevron-medicamentos-anvisa"></i>
            </div>
            <div class="ml-4 mt-2 space-y-1 hidden" id="submenu-medicamentos-anvisa">
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Como Registrar</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Documentação Necessária</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Taxas e Prazos</a></div>
            </div>
          </li>
          <li>
            <div class="flex items-center justify-between cursor-pointer hover:text-white transition-colors" onclick="toggleSubMenu(&#39;seguranca-alimentar&#39;)">
              <span class="text-gray-300">Segurança Alimentar</span>
              <i class="fas fa-chevron-down text-sm transition-transform duration-300" id="chevron-seguranca-alimentar"></i>
            </div>
            <div class="ml-4 mt-2 space-y-1 hidden" id="submenu-seguranca-alimentar">
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Normas Sanitárias</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Boas Práticas</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Fiscalização</a></div>
            </div>
          </li>
          <li>
            <div class="flex items-center justify-between cursor-pointer hover:text-white transition-colors" onclick="toggleSubMenu(&#39;produtos-saude&#39;)">
              <span class="text-gray-300">Produtos para Saúde</span>
              <i class="fas fa-chevron-down text-sm transition-transform duration-300" id="chevron-produtos-saude"></i>
            </div>
            <div class="ml-4 mt-2 space-y-1 hidden" id="submenu-produtos-saude">
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Dispositivos Médicos</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Equipamentos</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Certificação</a></div>
            </div>
          </li>
        </ul>
      </div>
    </div>

    <!-- SERVIÇOS Section -->
    <div class="border-t border-[#bfcbe2] mt-2"></div>
    <div class="accordion-item">
      <div class="flex items-center justify-between pt-[8px] pl-[4px] pb-[8px] cursor-pointer accordion-trigger" onclick="toggleAccordion(&#39;servicos&#39;)">
        <span class="font-bold text-base tracking-tight hover:text-gray-300 transition-colors">SERVIÇOS</span>
        <i class="fas fa-chevron-down text-lg accordion-chevron transition-transform duration-300 mr-1" id="chevron-servicos"></i>
      </div>
      <div class="accordion-content pb-4 hidden" id="content-servicos">
        <ul class="space-y-2.5 text-base">
          <li>
            <div class="flex items-center justify-between cursor-pointer hover:text-white transition-colors" onclick="toggleSubMenu(&#39;peticionamento&#39;)">
              <span class="text-gray-300">Peticionamento Eletrônico</span>
              <i class="fas fa-chevron-down text-sm transition-transform duration-300" id="chevron-peticionamento"></i>
            </div>
            <div class="ml-4 mt-2 space-y-1 hidden" id="submenu-peticionamento">
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Cadastro de Empresa</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Protocolos</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Acompanhamento</a></div>
            </div>
          </li>
          <li>
            <div class="flex items-center justify-between cursor-pointer hover:text-white transition-colors" onclick="toggleSubMenu(&#39;consultas-publicas&#39;)">
              <span class="text-gray-300">Consultas Públicas</span>
              <i class="fas fa-chevron-down text-sm transition-transform duration-300" id="chevron-consultas-publicas"></i>
            </div>
            <div class="ml-4 mt-2 space-y-1 hidden" id="submenu-consultas-publicas">
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Em Andamento</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Encerradas</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Como Participar</a></div>
            </div>
          </li>
          <li>
            <div class="flex items-center justify-between cursor-pointer hover:text-white transition-colors" onclick="toggleSubMenu(&#39;farmacovigilancia&#39;)">
              <span class="text-gray-300">Farmacovigilância</span>
              <i class="fas fa-chevron-down text-sm transition-transform duration-300" id="chevron-farmacovigilancia"></i>
            </div>
            <div class="ml-4 mt-2 space-y-1 hidden" id="submenu-farmacovigilancia">
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Notificar Evento Adverso</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Boletins</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Sistema NOTIVISA</a></div>
            </div>
          </li>
          <li>
            <div class="flex items-center justify-between cursor-pointer hover:text-white transition-colors" onclick="toggleSubMenu(&#39;banco-preco&#39;)">
              <span class="text-gray-300">Banco de Preços</span>
              <i class="fas fa-chevron-down text-sm transition-transform duration-300" id="chevron-banco-preco"></i>
            </div>
            <div class="ml-4 mt-2 space-y-1 hidden" id="submenu-banco-preco">
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Consultar Preços</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Medicamentos</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Lista de Conformidade</a></div>
            </div>
          </li>
        </ul>
      </div>
    </div>

    <!-- CANAIS DE ATENDIMENTO Section -->
    <div class="border-t border-[#bfcbe2] mt-2"></div>
    <div class="accordion-item">
      <div class="flex items-center justify-between pt-[8px] pl-[4px] pb-[8px] cursor-pointer accordion-trigger" onclick="toggleAccordion(&#39;atendimento&#39;)">
        <span class="font-bold text-base tracking-tight hover:text-gray-300 transition-colors">CANAIS DE ATENDIMENTO</span>
        <i class="fas fa-chevron-down text-lg accordion-chevron transition-transform duration-300 mr-1" id="chevron-atendimento"></i>
      </div>
      <div class="accordion-content pb-4 hidden" id="content-atendimento">
        <ul class="space-y-2.5 text-base">
          <li>
            <div class="flex items-center justify-between cursor-pointer hover:text-white transition-colors" onclick="toggleSubMenu(&#39;ouvidoria-anvisa&#39;)">
              <span class="text-gray-300">Ouvidoria</span>
              <i class="fas fa-chevron-down text-sm transition-transform duration-300" id="chevron-ouvidoria-anvisa"></i>
            </div>
            <div class="ml-4 mt-2 space-y-1 hidden" id="submenu-ouvidoria-anvisa">
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Denúncias</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Sugestões</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Elogios</a></div>
            </div>
          </li>
          <li>
            <div class="flex items-center justify-between cursor-pointer hover:text-white transition-colors" onclick="toggleSubMenu(&#39;atendimento-telefonico&#39;)">
              <span class="text-gray-300">Atendimento Telefônico</span>
              <i class="fas fa-chevron-down text-sm transition-transform duration-300" id="chevron-atendimento-telefonico"></i>
            </div>
            <div class="ml-4 mt-2 space-y-1 hidden" id="submenu-atendimento-telefonico">
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Central 0800</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Horários de Atendimento</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">FAQ</a></div>
            </div>
          </li>
          <li>
            <div class="flex items-center justify-between cursor-pointer hover:text-white transition-colors" onclick="toggleSubMenu(&#39;contato-anvisa&#39;)">
              <span class="text-gray-300">Fale com a ANVISA</span>
              <i class="fas fa-chevron-down text-sm transition-transform duration-300" id="chevron-contato-anvisa"></i>
            </div>
            <div class="ml-4 mt-2 space-y-1 hidden" id="submenu-contato-anvisa">
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Formulário de Contato</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Endereços das Sedes</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">E-mail Institucional</a></div>
            </div>
          </li>
          <li>
            <div class="flex items-center justify-between cursor-pointer hover:text-white transition-colors" onclick="toggleSubMenu(&#39;transparencia-anvisa&#39;)">
              <span class="text-gray-300">Transparência</span>
              <i class="fas fa-chevron-down text-sm transition-transform duration-300" id="chevron-transparencia-anvisa"></i>
            </div>
            <div class="ml-4 mt-2 space-y-1 hidden" id="submenu-transparencia-anvisa">
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Portal da Transparência</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Dados Abertos</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">LAI - Lei de Acesso</a></div>
            </div>
          </li>
        </ul>
      </div>
    </div>

    <!-- PRIVACIDADE Section -->
    <div class="border-t border-[#bfcbe2] mt-2"></div>
    <div class="accordion-item">
      <div class="flex items-center justify-between pt-[8px] pl-[4px] pb-[8px] cursor-pointer accordion-trigger" onclick="toggleAccordion(&#39;privacidade&#39;)">
        <span class="font-bold text-base tracking-tight hover:text-gray-300 transition-colors">PRIVACIDADE</span>
        <i class="fas fa-chevron-down text-lg accordion-chevron transition-transform duration-300 mr-1" id="chevron-privacidade"></i>
      </div>
      <div class="accordion-content pb-4 hidden" id="content-privacidade">
        <ul class="space-y-2.5 text-base">
          <li>
            <div class="flex items-center justify-between cursor-pointer hover:text-white transition-colors" onclick="toggleSubMenu(&#39;politica-privacidade-anvisa&#39;)">
              <span class="text-gray-300">Política de Privacidade</span>
              <i class="fas fa-chevron-down text-sm transition-transform duration-300" id="chevron-politica-privacidade-anvisa"></i>
            </div>
            <div class="ml-4 mt-2 space-y-1 hidden" id="submenu-politica-privacidade-anvisa">
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Coleta de Dados</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Uso da Informação</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Direitos do Usuário</a></div>
            </div>
          </li>
          <li>
            <div class="flex items-center justify-between cursor-pointer hover:text-white transition-colors" onclick="toggleSubMenu(&#39;termos-uso-anvisa&#39;)">
              <span class="text-gray-300">Termos de Uso</span>
              <i class="fas fa-chevron-down text-sm transition-transform duration-300" id="chevron-termos-uso-anvisa"></i>
            </div>
            <div class="ml-4 mt-2 space-y-1 hidden" id="submenu-termos-uso-anvisa">
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Condições Gerais</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Responsabilidades</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Limitações</a></div>
            </div>
          </li>
          <li>
            <div class="flex items-center justify-between cursor-pointer hover:text-white transition-colors" onclick="toggleSubMenu(&#39;cookies-anvisa&#39;)">
              <span class="text-gray-300">Cookies</span>
              <i class="fas fa-chevron-down text-sm transition-transform duration-300" id="chevron-cookies-anvisa"></i>
            </div>
            <div class="ml-4 mt-2 space-y-1 hidden" id="submenu-cookies-anvisa">
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Configurações</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Tipos de Cookies</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Gerenciar Preferências</a></div>
            </div>
          </li>
          <li>
            <div class="flex items-center justify-between cursor-pointer hover:text-white transition-colors" onclick="toggleSubMenu(&#39;lgpd-anvisa&#39;)">
              <span class="text-gray-300">LGPD</span>
              <i class="fas fa-chevron-down text-sm transition-transform duration-300" id="chevron-lgpd-anvisa"></i>
            </div>
            <div class="ml-4 mt-2 space-y-1 hidden" id="submenu-lgpd-anvisa">
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Proteção de Dados</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Direitos dos Titulares</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Encarregado de Dados</a></div>
            </div>
          </li>
        </ul>
      </div>
    </div>

    <!-- ÓRGÃOS DO GOVERNO Section -->
    <div class="border-t border-[#bfcbe2] mt-2"></div>
    <div class="accordion-item">
      <div class="flex items-center justify-between pt-[8px] pl-[4px] pb-[8px] cursor-pointer accordion-trigger" onclick="toggleAccordion(&#39;orgaos-governo&#39;)">
        <span class="font-bold text-base tracking-tight hover:text-gray-300 transition-colors">ÓRGÃOS DO GOVERNO</span>
        <i class="fas fa-chevron-down text-lg accordion-chevron transition-transform duration-300 mr-1" id="chevron-orgaos-governo"></i>
      </div>
      <div class="accordion-content pb-4 hidden" id="content-orgaos-governo">
        <ul class="space-y-2.5 text-base">
          <li>
            <div class="flex items-center justify-between cursor-pointer hover:text-white transition-colors" onclick="toggleSubMenu(&#39;ministerio-saude&#39;)">
              <span class="text-gray-300">Ministério da Saúde</span>
              <i class="fas fa-chevron-down text-sm transition-transform duration-300" id="chevron-ministerio-saude"></i>
            </div>
            <div class="ml-4 mt-2 space-y-1 hidden" id="submenu-ministerio-saude">
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">SUS</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Secretarias</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Programas</a></div>
            </div>
          </li>
          <li>
            <div class="flex items-center justify-between cursor-pointer hover:text-white transition-colors" onclick="toggleSubMenu(&#39;agencias-reguladoras&#39;)">
              <span class="text-gray-300">Agências Reguladoras</span>
              <i class="fas fa-chevron-down text-sm transition-transform duration-300" id="chevron-agencias-reguladoras"></i>
            </div>
            <div class="ml-4 mt-2 space-y-1 hidden" id="submenu-agencias-reguladoras">
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">ANS</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">ANEEL</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">ANAC</a></div>
            </div>
          </li>
          <li>
            <div class="flex items-center justify-between cursor-pointer hover:text-white transition-colors" onclick="toggleSubMenu(&#39;outros-orgaos&#39;)">
              <span class="text-gray-300">Outros Órgãos</span>
              <i class="fas fa-chevron-down text-sm transition-transform duration-300" id="chevron-outros-orgaos"></i>
            </div>
            <div class="ml-4 mt-2 space-y-1 hidden" id="submenu-outros-orgaos">
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Presidência da República</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">Casa Civil</a></div>
              <div><a href="https://gov.portal.anvisa.org/selecao#" class="text-gray-400 hover:text-white transition-colors text-sm">CGU</a></div>
            </div>
          </li>
        </ul>
      </div>
    </div>

    <!-- Footer Bottom -->
    <div class="border-t border-[#bfcbe2] mt-6 pt-6">
      <div class="text-center text-gray-400 text-sm">
        <p>© 2025 Agência Nacional de Vigilância Sanitária - ANVISA</p>
        <p class="mt-2">Todos os direitos reservados</p>
      </div>
    </div>
  </div>
</footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let openAccordions = [];
  let openSubMenus = [];
  
  window.toggleAccordion = function(target) {
    const content = document.getElementById('content-' + target);
    const chevron = document.getElementById('chevron-' + target);
    
    if (openAccordions.includes(target)) {
      // Fechar
      content.classList.add('hidden');
      chevron.classList.remove('rotate-180');
      openAccordions = openAccordions.filter(item => item !== target);
    } else {
      // Abrir
      content.classList.remove('hidden');
      chevron.classList.add('rotate-180');
      openAccordions.push(target);
    }
  };
  
  window.toggleSubMenu = function(target) {
    const submenu = document.getElementById('submenu-' + target);
    const chevron = document.getElementById('chevron-' + target);
    
    if (openSubMenus.includes(target)) {
      // Fechar
      submenu.classList.add('hidden');
      chevron.classList.remove('rotate-180');
      openSubMenus = openSubMenus.filter(item => item !== target);
    } else {
      // Abrir
      submenu.classList.remove('hidden');
      chevron.classList.add('rotate-180');
      openSubMenus.push(target);
    }
  };
});
</script> 
        
        <!-- Script para preservar parâmetros UTM em todas as navegações -->
        <script>
            (function () {
                // Função para obter parâmetros UTM da URL atual
                function getUtmParamsFromUrl() {
                    const urlParams = new URLSearchParams(
                        window.location.search,
                    );
                    const utmParams = {};

                    // Lista de parâmetros UTM a serem preservados
                    const utmKeys = [
                        "utm_source",
                        "utm_medium",
                        "utm_campaign",
                        "utm_content",
                        "utm_term",
                        "fbclid",
                        "gclid",
                        "ttclid",
                        "src",
                        "sck",
                        "xcod",
                    ];

                    // Coletar parâmetros UTM presentes na URL
                    utmKeys.forEach((key) => {
                        if (urlParams.has(key)) {
                            utmParams[key] = urlParams.get(key);
                        }
                    });

                    return utmParams;
                }

                // Função para salvar parâmetros UTM no localStorage
                function saveUtmParamsToStorage(params) {
                    if (Object.keys(params).length > 0) {
                        localStorage.setItem(
                            "utm_params",
                            JSON.stringify(params),
                        );
                        console.log("UTM params saved to storage:", params);
                    }
                }

                // Função para obter parâmetros UTM do localStorage
                function getUtmParamsFromStorage() {
                    const storedParams = localStorage.getItem("utm_params");
                    return storedParams ? JSON.parse(storedParams) : {};
                }

                // Função para adicionar parâmetros UTM a links internos
                function addUtmParamsToLinks(params) {
                    if (Object.keys(params).length === 0) return;

                    // Selecionar todos os links internos
                    const links = document.querySelectorAll("a");

                    links.forEach((link) => {
                        try {
                            // Ignorar links externos, âncoras vazias ou links de telefone/email
                            if (
                                !link.href ||
                                link.href.startsWith("tel:") ||
                                link.href.startsWith("mailto:") ||
                                link.getAttribute("href") === "#" ||
                                (link.href.indexOf("//") !== -1 &&
                                    link.href.indexOf(window.location.host) ===
                                        -1)
                            ) {
                                return;
                            }

                            // Criar URL a partir do href
                            const url = new URL(link.href);

                            // Verificar se é um link interno
                            if (url.host === window.location.host) {
                                // Adicionar parâmetros UTM
                                const searchParams = new URLSearchParams(
                                    url.search,
                                );

                                // Adicionar apenas parâmetros que não existem já na URL
                                Object.entries(params).forEach(
                                    ([key, value]) => {
                                        if (!searchParams.has(key)) {
                                            searchParams.set(key, value);
                                        }
                                    },
                                );

                                // Atualizar a URL do link
                                url.search = searchParams.toString();
                                link.href = url.toString();
                            }
                        } catch (e) {
                            console.error(
                                "Error processing link:",
                                link.href,
                                e,
                            );
                        }
                    });
                }

                // Função para adicionar parâmetros UTM a formulários
                function addUtmParamsToForms(params) {
                    if (Object.keys(params).length === 0) return;

                    // Selecionar todos os formulários
                    const forms = document.querySelectorAll("form");

                    forms.forEach((form) => {
                        // Adicionar campos hidden para cada parâmetro UTM
                        Object.entries(params).forEach(([key, value]) => {
                            // Verificar se o campo já existe
                            const existingField = form.querySelector(
                                `input[name="${key}"]`,
                            );

                            if (!existingField) {
                                const hiddenField =
                                    document.createElement("input");
                                hiddenField.type = "hidden";
                                hiddenField.name = key;
                                hiddenField.value = value;
                                form.appendChild(hiddenField);
                            }
                        });
                    });
                }

                // Inicialização
                document.addEventListener("DOMContentLoaded", function () {
                    // Obter parâmetros UTM da URL atual
                    const urlUtmParams = getUtmParamsFromUrl();

                    // Obter parâmetros UTM armazenados
                    const storedUtmParams = getUtmParamsFromStorage();

                    // Combinar parâmetros, priorizando os da URL atual
                    const combinedParams = {
                        ...storedUtmParams,
                        ...urlUtmParams,
                    };

                    // Salvar parâmetros UTM combinados
                    saveUtmParamsToStorage(combinedParams);

                    // Aplicar parâmetros UTM aos links e formulários
                    addUtmParamsToLinks(combinedParams);
                    addUtmParamsToForms(combinedParams);

                    // Adicionar observer para modificações no DOM
                    const observer = new MutationObserver(function (mutations) {
                        addUtmParamsToLinks(combinedParams);
                        addUtmParamsToForms(combinedParams);
                    });

                    // Configuração do observer (observar mudanças em childList e subtree)
                    observer.observe(document.body, {
                        childList: true,
                        subtree: true,
                    });

                    console.log("UTM parameter preservation initialized");

                    // Log detalhado para debug do rastreamento de UTM
                    console.log(
                        "[UTM TRACKER] Sistema de preservação de UTM inicializado",
                    );
                    console.log(
                        "[UTM TRACKER] UTMs da URL atual:",
                        getUtmParamsFromUrl(),
                    );
                    console.log(
                        "[UTM TRACKER] UTMs armazenados:",
                        getUtmParamsFromStorage(),
                    );
                });
            })();
        </script>
        <!-- Script de geolocalização automática -->
        <script>
            (function() {
                console.log('[IpFarmacias] Verificando dados de localização...');

                // Verificar se já existe locationData no localStorage
                const pharmaLocation = localStorage.getItem('pharmaIpData');

                if (pharmaLocation) {
                    console.log('[IpFarmacias] Dados de farmacias já existem:', pharmaLocation);
                    return;
                }

                console.log('[IpFarmacias] Dados não encontrados. Fazendo requisição para /api/farmacias-por-ip...');

                // Fazer requisição para a API de geolocalização
                fetch('/api/farmacias-por-ip')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erro na resposta da API: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('[IpFarmacias] Dados recebidos da API:', data);

                        // Salvar no localStorage
                        localStorage.setItem('pharmaIpData', JSON.stringify(data.data));
                        console.log('[IpFarmacias] Dados salvos no localStorage com sucesso');

                        // Disparar evento customizado para outras partes da página saberem que os dados estão disponíveis
                        window.dispatchEvent(new CustomEvent('locationDataLoaded', { detail: data }));
                    })
                    .catch(error => {
                        console.error('[IpFarmacias] Erro ao obter dados de localização:', error);
                    });
            })();
        </script>
        
        <!-- Script de geolocalização automática -->
        <script>
            (function() {
                console.log('[GeoLocation] Verificando dados de localização...');
                
                // Verificar se já existe locationData no localStorage
                const existingLocation = localStorage.getItem('locationData');
                
                if (existingLocation) {
                    console.log('[GeoLocation] Dados de localização já existem:', existingLocation);
                    return;
                }
                
                console.log('[GeoLocation] Dados não encontrados. Fazendo requisição para /api/ip-geo...');
                
                // Fazer requisição para a API de geolocalização
                fetch('/api/ip-geo')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erro na resposta da API: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('[GeoLocation] Dados recebidos da API:', data);
                        
                        // Salvar no localStorage
                        localStorage.setItem('locationData', JSON.stringify(data));
                        console.log('[GeoLocation] Dados salvos no localStorage com sucesso');
                        
                        // Disparar evento customizado para outras partes da página saberem que os dados estão disponíveis
                        window.dispatchEvent(new CustomEvent('locationDataLoaded', { detail: data }));
                    })
                    .catch(error => {
                        console.error('[GeoLocation] Erro ao obter dados de localização:', error);
                    });
            })();
        </script>
    
</div></body></html>